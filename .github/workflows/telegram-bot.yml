name: Telegram Bot

on:
  push:
    branches: [ telegram ]
  workflow_dispatch:
  schedule:
    # Run daily at 03:00 UTC (12:00 JST/UTC+9) for 1 hour
    # Monthly usage: 30 days Ã— 1 hour = 1800 minutes (within 2000 min free tier)
    - cron: '0 3 * * *'

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        ref: telegram

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create config from secrets
      run: |
        cat > config.json << EOF
        {
          "telegram": {
            "bot_token": "${{ secrets.TELEGRAM_BOT_TOKEN }}",
            "admin_user_ids": [${{ secrets.ADMIN_USER_IDS }}]
          },
          "api": {
            "base_url": "${{ secrets.API_BASE_URL }}",
            "token": "${{ secrets.API_TOKEN }}"
          }
        }
        EOF

    - name: Run Telegram Bot
      timeout-minutes: 60  # 1 hour timeout
      run: |
        python3 bot.py
