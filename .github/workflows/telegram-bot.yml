name: Telegram Bot

on:
  push:
    branches: [ telegram ]
  workflow_dispatch:
  schedule:
    # Run daily at 07:30 UTC (16:30 JST/UTC+9) for 2.5 hours
    # Only runs on even-numbered weeks (bi-weekly)
    # Monthly usage: ~15 days × 2.5 hours × 60 min = 2250 minutes
    - cron: '30 7 * * *'

jobs:
  run-bot:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        ref: telegram

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        pip install -r requirements.txt

    - name: Create config from secrets
      run: |
        cat > config.json << EOF
        {
          "telegram": {
            "bot_token": "${{ secrets.TELEGRAM_BOT_TOKEN }}",
            "admin_user_ids": [${{ secrets.ADMIN_USER_IDS }}]
          },
          "api": {
            "base_url": "${{ secrets.API_BASE_URL }}",
            "token": "${{ secrets.API_TOKEN }}"
          }
        }
        EOF

    - name: Check if even week
      id: check_week
      run: |
        WEEK_NUMBER=$(date +%V)
        if [ $((WEEK_NUMBER % 2)) -eq 0 ]; then
          echo "is_even_week=true" >> $GITHUB_OUTPUT
        else
          echo "is_even_week=false" >> $GITHUB_OUTPUT
        fi

    - name: Run Telegram Bot
      if: steps.check_week.outputs.is_even_week == 'true'
      timeout-minutes: 150  # 2.5 hours timeout (16:30-19:00 JST)
      run: |
        python3 bot.py
