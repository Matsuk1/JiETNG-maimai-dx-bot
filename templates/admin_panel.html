<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Admin Panel | JiETNG</title>
  <link rel="icon" type="image/png" href="/static/pics/logo.png">
  {% include 'common_styles.html' %}

  <style>
    /* È°µÈù¢ÁâπÂÆö CSS ÂèòÈáè - Page-specific CSS Variables */
    :root {
      --hover-bg: rgba(0, 0, 0, 0.04);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --hover-bg: rgba(255, 255, 255, 0.08);
      }
    }

    /* È°µÈù¢ÁâπÂÆöÊ†∑Âºè - Page-specific Styles */
    body {
      padding: 20px;
      background: var(--surface-bg);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding: 24px 32px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-color);
      letter-spacing: -0.5px;
    }

    .logout-btn {
      padding: 10px 20px;
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      text-decoration: none;
      display: inline-block;
    }

    .logout-btn:hover {
      opacity: 0.9;
      box-shadow: var(--shadow-md);
    }

    .logout-btn:active {
      transform: scale(0.98);
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      padding: 4px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      overflow-x: auto;
    }

    .tab {
      padding: 10px 20px;
      background: transparent;
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
      white-space: nowrap;
    }

    .tab:hover {
      color: var(--text-color);
      background: var(--hover-bg);
    }

    .tab.active {
      color: white;
      background: var(--accent-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 16px;
      box-shadow: var(--shadow-sm);
    }

    .section-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--text-color);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .user-list {
      display: grid;
      gap: 12px;
    }

    .user-item {
      background-color: var(--surface-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      transition: all var(--transition-base);
    }

    .user-item:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-sm);
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .user-id {
      font-weight: 600;
      font-size: 14px;
      color: var(--accent-color);
      font-family: 'Courier New', monospace;
    }

    .user-nickname {
      font-size: 14px;
      color: var(--text-color);
      margin-left: 12px;
      opacity: 0.7;
    }

    .user-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .user-info-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .user-info-label {
      font-weight: 600;
      color: var(--text-color);
      opacity: 0.7;
    }

    .user-info-value {
      color: var(--accent-color);
      font-family: 'Courier New', monospace;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 28px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-xl);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent-color);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
      opacity: 0.5;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.3s;
    }

    .close-btn:hover {
      opacity: 1;
      background-color: var(--hover-bg);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 8px;
      opacity: 0.8;
    }

    .form-input, .form-textarea {
      width: 100%;
      padding: 10px 14px;
      background-color: var(--surface-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--text-color);
      font-family: 'Courier New', monospace;
      transition: all var(--transition-base);
    }

    .form-textarea {
      min-height: 200px;
      resize: vertical;
    }

    .form-input:hover, .form-textarea:hover {
      border-color: var(--border-hover);
    }

    .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      background-color: var(--card-bg);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn-cancel {
      background-color: var(--border-color);
      color: var(--text-color);
    }

    /* Loading spinner */
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .nickname-loading {
      opacity: 0.5;
      font-style: italic;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius-md);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .btn-primary {
      background: var(--info-color);
      color: white;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-danger {
      background: var(--danger-color);
      color: white;
    }

    .btn-warning {
      background: var(--warning-color);
      color: white;
    }

    .btn:hover {
      opacity: 0.9;
      box-shadow: var(--shadow-sm);
    }

    .btn:active {
      transform: scale(0.97);
    }

    .user-data {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .user-data.expanded {
      display: block;
    }

    .json-viewer {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    .json-viewer pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--text-color);
      line-height: 1.5;
    }

    .task-item {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-info {
      flex: 1;
    }

    .task-type {
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 4px;
    }

    .task-user {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
      font-family: 'Courier New', monospace;
    }

    .task-time {
      font-size: 11px;
      color: var(--text-color);
      opacity: 0.5;
      margin-top: 4px;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-right: 12px;
    }

    .status-running {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--success-color);
    }

    .status-queued {
      background-color: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }

    .status-cancelled {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      text-decoration: line-through;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: var(--surface-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 20px;
      text-align: center;
      transition: all var(--transition-base);
    }

    .stat-card:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--border-hover);
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent-color);
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .search-box {
      width: 100%;
      padding: 10px 14px;
      background-color: var(--surface-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 14px;
      color: var(--text-color);
      margin-bottom: 16px;
      font-family: inherit;
      transition: all var(--transition-base);
    }

    .search-box:hover {
      border-color: var(--border-hover);
    }

    .search-box:focus {
      outline: none;
      border-color: var(--accent-color);
      background-color: var(--card-bg);
      box-shadow: 0 0 0 3px var(--accent-light);
    }

    .log-viewer {
      background-color: var(--surface-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      font-family: 'Courier New', Monaco, monospace;
      font-size: 12px;
      line-height: 1.5;
      height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-color);
      opacity: 0.5;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-success {
      background: linear-gradient(135deg, var(--success-color), #059669);
      color: white;
    }

    .badge-secondary {
      background: var(--border-color);
      color: var(--text-color);
      opacity: 0.6;
    }

    table tbody tr:hover {
      background-color: var(--hover-bg);
    }

    .toggle-icon {
      font-size: 12px;
      margin-left: 8px;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      body {
        /* ÁßªÂä®Á´ØÔºösafe-area padding Â∑≤Âú® :root ‰∏äÔºåËøôÈáåÂè™Âä†È¢ùÂ§ñÁöÑ 10px */
        padding: 10px;
      }

      .container {
        max-width: 100%;
      }

      .header {
        flex-direction: column;
        gap: 16px;
        padding: 16px;
      }

      .header h1 {
        font-size: 24px;
        text-align: center;
      }

      .tabs {
        overflow-x: auto;
        gap: 8px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        padding-bottom: 8px;
      }

      .tabs::-webkit-scrollbar {
        display: none;
      }

      .tab {
        font-size: 13px;
        padding: 10px 16px;
        white-space: nowrap;
        min-width: fit-content;
      }

      .section {
        padding: 20px 16px;
        margin-bottom: 16px;
      }

      .section-title {
        font-size: 18px;
        margin-bottom: 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .stat-card {
        padding: 20px 16px;
      }

      .stat-value {
        font-size: 28px;
      }

      .stat-label {
        font-size: 12px;
      }

      .user-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .user-info h3 {
        font-size: 16px;
      }

      .user-info p {
        font-size: 13px;
      }

      .user-actions {
        flex-direction: column;
        width: 100%;
        gap: 8px;
      }

      .user-actions .btn {
        width: 100%;
        padding: 12px 16px;
        font-size: 14px;
        justify-content: center;
      }

      .task-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        padding: 16px;
      }

      .task-item > div:first-child {
        width: 100%;
      }

      .task-item > div:last-child {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .task-item .btn {
        width: 100%;
        padding: 12px 16px;
        font-size: 14px;
        justify-content: center;
      }

      .task-item .status-badge {
        width: 100%;
        text-align: center;
        padding: 8px 12px;
      }

      .modal-content {
        margin: 10px;
        max-width: calc(100% - 20px);
        padding: 24px 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
      }

      .modal-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
        margin-bottom: 20px;
      }

      .modal-header h2 {
        font-size: 20px;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        font-size: 13px;
        margin-bottom: 6px;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        padding: 12px;
        font-size: 15px;
      }

      .form-actions {
        flex-direction: column;
        gap: 10px;
      }

      .form-actions .btn {
        width: 100%;
        padding: 14px;
        font-size: 15px;
        justify-content: center;
      }

      /* ‰ºòÂåñÂç°ÁâáÈó¥Ë∑ù */
      .user-card {
        margin-bottom: 12px;
      }

      /* ‰ºòÂåñÂÖ¨ÂëäÂç°Áâá */
      .announcement-card {
        padding: 16px;
      }

      /* Á°Æ‰øùË°®ÂçïÂÖÉÁ¥†‰∏ç‰ºöÊ∫¢Âá∫ */
      input, select, textarea, button {
        max-width: 100%;
      }

      /* ‰ºòÂåñÊªöÂä®Êù° */
      .task-list {
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Admin Control Panel</h1>
      <a href="/admin/logout" class="logout-btn">Logout</a>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('stats')">Statistics</button>
      <button class="tab" onclick="switchTab('users')">Users</button>
      <button class="tab" onclick="switchTab('tasks')">Task Queue</button>
      <button class="tab" onclick="switchTab('dxdata')">DxData</button>
      <button class="tab" onclick="switchTab('notices')">Notices</button>
      <button class="tab" onclick="switchTab('tipad')">Tip/Ad</button>
      <button class="tab" onclick="switchTab('backups')">Backups</button>
      <button class="tab" onclick="switchTab('logs')">Logs</button>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <div class="section">
        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
          <span>User Management ({{ total_users }} users)</span>
          <button class="btn btn-warning" onclick="clearNicknameCache()" style="font-size: 12px;">
            Clear Nickname Cache
          </button>
        </div>

        <!-- Loading indicator -->
        <div id="nickname-loading" style="display: flex; align-items: center; justify-content: center; padding: 20px; gap: 12px;">
          <div class="spinner"></div>
          <span style="color: var(--text-color); opacity: 0.7;">Loading user nicknames...</span>
        </div>

        <input type="text" class="search-box" id="user-search" placeholder="Search by User ID or Nickname..." onkeyup="filterUsers()">

        <div class="user-list" id="user-list">
          {% if users_data %}
            {% for user_id, user_data in users_data.items() %}
            <div class="user-item" data-user-id="{{ user_id }}" data-nickname="{{ user_data.nickname|lower }}">
              <div class="user-header" onclick="toggleUserData('{{ user_id }}')">
                <div>
                  <span class="user-id">{{ user_id }}</span>
                  <span class="user-nickname">{{ user_data.nickname }}</span>
                </div>
                <div class="user-actions" onclick="event.stopPropagation()">
                  <button class="btn btn-primary" onclick="triggerUpdate('{{ user_id }}')">Update</button>
                  <button class="btn btn-success" onclick="refreshUserData('{{ user_id }}')">Refresh</button>
                  <button class="btn btn-warning" onclick="editUser('{{ user_id }}')">Edit</button>
                  <button class="btn btn-danger" onclick="deleteUser('{{ user_id }}')">Delete</button>
                  <span class="toggle-icon" id="toggle-{{ user_id }}">‚ñº</span>
                </div>
              </div>
              <div class="user-data" id="data-{{ user_id }}">
                <div class="json-viewer"><pre>{{ user_data.json_str }}</pre></div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty-state">No users found</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasks-tab" class="tab-content">
      <div class="section">
        <div class="section-title">Running Tasks ({{ running_tasks|length }})</div>
        {% if running_tasks %}
          {% for task in running_tasks %}
          <div class="task-item">
            <div class="task-info">
              <div class="task-type">{{ task.function }}</div>
              <div class="task-user">User: {{ task.user_id }} ({{ task.nickname }})</div>
              <div class="task-time">Started: {{ task.start_time }}</div>
            </div>
            <div>
              <span class="status-badge status-running">Running</span>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">No running tasks</div>
        {% endif %}
      </div>

      <div class="section">
        <div class="section-title">Queued Tasks ({{ queued_tasks|length }})</div>
        {% if queued_tasks %}
          {% for task in queued_tasks %}
          <div class="task-item">
            <div class="task-info">
              <div class="task-type">{{ task.function }}</div>
              <div class="task-user">User: {{ task.user_id }} ({{ task.nickname }})</div>
              <div class="task-time">Queued: {{ task.queue_time }}</div>
            </div>
            <div>
              {% if task.status == 'cancelled' %}
                <span class="status-badge status-cancelled">Cancelled</span>
              {% else %}
                <span class="status-badge status-queued">Queued</span>
                <button class="btn btn-danger" onclick="cancelTask('{{ task.id }}')">Cancel</button>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">No queued tasks</div>
        {% endif %}
      </div>

      <div class="section">
        <div class="section-title">Completed Tasks (Last 20)</div>
        {% if completed_tasks %}
          {% for task in completed_tasks %}
          <div class="task-item">
            <div class="task-info">
              <div class="task-type">{{ task.function }}</div>
              <div class="task-user">User: {{ task.user_id }} ({{ task.nickname }})</div>
              <div class="task-time">Started: {{ task.start_time }} | Finished: {{ task.end_time }}</div>
              <div class="task-time">Duration: {{ task.duration }}</div>
            </div>
            <div>
              <span class="status-badge" style="background-color: rgba(23, 162, 184, 0.1); color: var(--info-color);">Completed</span>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">No completed tasks yet</div>
        {% endif %}
      </div>

      <div style="margin-top: 12px; text-align: center;">
        <button class="btn btn-primary" onclick="refreshTasks()">Refresh Tasks</button>
      </div>
    </div>

    <!-- Stats Tab -->
    <div id="stats-tab" class="tab-content active">
      <!-- Main Statistics Cards -->
      <div class="section">
        <div class="section-title">System Overview</div>
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Total Users</div>
            <div class="stat-value" style="font-size: 32px;">{{ stats.total_users }}</div>
            <div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Registered accounts</div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">CPU Usage</div>
            <div class="stat-value" style="font-size: 32px;">{{ stats.cpu_percent }}<span style="font-size: 18px; margin-left: 4px;">%</span></div>
            <div style="width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; margin-top: 8px; opacity: 0.3;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 3px; width: {{ stats.cpu_percent }}%;"></div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Memory</div>
            <div class="stat-value" style="font-size: 32px;">{{ stats.memory_percent }}<span style="font-size: 18px; margin-left: 4px;">%</span></div>
            <div style="width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; margin-top: 8px; opacity: 0.3;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 3px; width: {{ stats.memory_percent }}%;"></div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Uptime</div>
            <div class="stat-value" style="font-size: 24px;">{{ stats.uptime }}</div>
            <div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Service running</div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Tasks Processed</div>
            <div class="stat-value" style="font-size: 28px;">{{ stats.total_tasks_processed }}</div>
            <div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Total completed</div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Active Threads</div>
            <div class="stat-value" style="font-size: 32px;">{{ stats.thread_count }}</div>
            <div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Worker threads</div>
          </div>
        </div>
      </div>

      <!-- System Resources -->
      <div class="section">
        <div class="section-title">System Resources</div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 120px; font-size: 13px; opacity: 0.7;">CPU Cores</div>
            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; opacity: 0.3; overflow: hidden;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 4px; width: {{ (stats.cpu_count_used / stats.cpu_count_total * 100) if stats.cpu_count_total > 0 else 0 }}%;"></div>
            </div>
            <div style="min-width: 80px; text-align: right; font-size: 13px; font-weight: 600;">{{ stats.cpu_count_used }} / {{ stats.cpu_count_total }}</div>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 120px; font-size: 13px; opacity: 0.7;">Memory</div>
            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; opacity: 0.3; overflow: hidden;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 4px; width: {{ stats.memory_percent }}%;"></div>
            </div>
            <div style="min-width: 80px; text-align: right; font-size: 13px; font-weight: 600;">{{ stats.memory_used_gb }} / {{ stats.total_memory }} GB</div>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 120px; font-size: 13px; opacity: 0.7;">Image Queue</div>
            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; opacity: 0.3; overflow: hidden;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 4px; width: {{ (stats.image_queue_size / stats.max_queue_size * 100) if stats.max_queue_size > 0 else 0 }}%;"></div>
            </div>
            <div style="min-width: 80px; text-align: right; font-size: 13px; font-weight: 600;">{{ stats.image_queue_size }} / {{ stats.max_queue_size }}</div>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 120px; font-size: 13px; opacity: 0.7;">Web Queue</div>
            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; opacity: 0.3; overflow: hidden;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 4px; width: {{ (stats.web_queue_size / stats.max_queue_size * 100) if stats.max_queue_size > 0 else 0 }}%;"></div>
            </div>
            <div style="min-width: 80px; text-align: right; font-size: 13px; font-weight: 600;">{{ stats.web_queue_size }} / {{ stats.max_queue_size }}</div>
          </div>
        </div>

        <!-- User Distribution -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">JP Users</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">{{ stats.jp_users }}</div>
            <div style="font-size: 13px; opacity: 0.5;">{{ stats.jp_percent }}% of total</div>
          </div>
          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">INTL Users</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">{{ stats.intl_users }}</div>
            <div style="font-size: 13px; opacity: 0.5;">{{ stats.intl_percent }}% of total</div>
          </div>
        </div>
      </div>

      <!-- Memory Management -->
      <div class="section">
        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
          <span>Memory Management</span>
          <button class="btn btn-warning" onclick="triggerMemoryCleanup()" style="font-size: 12px;">
            Trigger Cleanup
          </button>
        </div>

        <div id="memory-stats-container">
          <div style="text-align: center; padding: 40px; opacity: 0.5;">
            Loading memory stats...
          </div>
        </div>

        <div style="margin-top: 12px; text-align: center;">
          <button class="btn btn-primary" onclick="loadMemoryStats()">Refresh Stats</button>
        </div>
      </div>

      <!-- System Information -->
      <div class="section">
        <div class="section-title">System Information</div>

        <div style="margin-bottom: 20px;">
          <span style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 20px; font-size: 13px; font-weight: 600;">
            <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--success-color); animation: pulse 2s infinite;"></span>
            Service Online
          </span>
        </div>

        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Python</span>
            <span style="font-weight: 600;">{{ stats.python_version }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Platform</span>
            <span style="font-weight: 600;">{{ stats.platform_short }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Hostname</span>
            <span style="font-weight: 600;" title="{{ stats.hostname }}">{{ stats.hostname[:8] }}{% if stats.hostname|length > 8 %}...{% endif %}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Port</span>
            <span style="font-weight: 600;">{{ stats.port }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Total Tasks</span>
            <span style="font-weight: 600;">{{ stats.total_tasks_processed }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Avg Response</span>
            <span style="font-weight: 600;">{{ stats.avg_response_time }}ms</span>
          </div>
        </div>

        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); opacity: 0.5; font-size: 13px;">
          <p>Last updated: {{ stats.timestamp }}</p>
        </div>
      </div>
    </div>

    <!-- Notices Tab -->
    <div id="notices-tab" class="tab-content">
      <div class="section">
        <div class="section-title">
          Notice Management
          <button class="btn btn-success" onclick="showCreateNoticeModal()" style="float: right;">Create New Notice</button>
        </div>

        <div id="notices-list">
          <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.5;">
            Loading notices...
          </div>
        </div>

        <div style="margin-top: 12px; text-align: center;">
          <button class="btn btn-primary" onclick="loadNotices()">Refresh</button>
        </div>
      </div>
    </div>

    <!-- DxData Tab -->
    <div id="dxdata-tab" class="tab-content">
      <!-- DXData Status Section -->
      <div class="section">
        <div class="section-title">DXData Status</div>

        <div id="dxdata-status-container">
          <div style="text-align: center; padding: 40px; opacity: 0.5;">
            Loading DXData status...
          </div>
        </div>

        <div style="margin-top: 12px; text-align: center;">
          <button class="btn btn-primary" onclick="loadDXDataStatus()">Refresh</button>
        </div>
      </div>

    </div>

    <!-- Tip/Ad Tab -->
    <div id="tipad-tab" class="tab-content">
      <div class="section">
        <div class="section-title">
          Tip/Ad Management
          <button class="btn btn-success" onclick="showCreateTipAdForm()" style="float: right;">Create New Tip/Ad</button>
        </div>

        <div id="tipadList">
          <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.5;">
            Loading tip/ad items...
          </div>
        </div>

        <div style="margin-top: 12px; text-align: center;">
          <button class="btn btn-primary" onclick="loadTipAds()">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Tip/Ad Form Modal -->
    <div id="tipadFormModal" class="modal">
      <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
          <h2 class="modal-title" id="tipadFormTitle">Create Tip/Ad</h2>
          <button class="close-btn" onclick="closeTipAdForm()">&times;</button>
        </div>

        <form id="tipadForm" onsubmit="saveTipAd(event)">
          <input type="hidden" id="tipad_id">

          <div class="form-group">
            <label class="form-label">Type:</label>
            <select id="tipad_type" required class="form-input">
              <option value="tip">üí° Tip</option>
              <option value="ad">üì¢ Ad</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Text (Chinese):</label>
            <textarea id="tipad_text_zh" required class="form-input" style="min-height: 80px;"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Text (English):</label>
            <textarea id="tipad_text_en" required class="form-input" style="min-height: 80px;"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Text (Japanese):</label>
            <textarea id="tipad_text_ja" required class="form-input" style="min-height: 80px;"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="tipad_has_button" onchange="toggleButtonFields()"> Add Button
            </label>
          </div>

          <div id="buttonFields" style="display: none; border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; background-color: var(--hover-bg);">
            <div class="form-group">
              <label class="form-label">Button Type:</label>
              <select id="tipad_button_type" class="form-input">
                <option value="uri">Link (URI)</option>
                <option value="message">Message</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Button Label (Chinese):</label>
              <input type="text" id="tipad_button_label_zh" class="form-input" placeholder="Êü•ÁúãËØ¶ÊÉÖ / Â∞ùËØï‰∏Ä‰∏ã">
            </div>

            <div class="form-group">
              <label class="form-label">Button Label (English):</label>
              <input type="text" id="tipad_button_label_en" class="form-input" placeholder="View Details / Try it">
            </div>

            <div class="form-group">
              <label class="form-label">Button Label (Japanese):</label>
              <input type="text" id="tipad_button_label_ja" class="form-input" placeholder="Ë©≥Á¥∞„ÇíË¶ã„Çã / Ë©¶„Åó„Å¶„Åø„Çã">
            </div>

            <div class="form-group">
              <label class="form-label">Button Value (URI or Message Text):</label>
              <input type="text" id="tipad_button_value" class="form-input">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="tipad_enabled" checked> Enabled
            </label>
          </div>

          <div class="form-actions">
            <button type="button" class="btn btn-cancel" onclick="closeTipAdForm()">Cancel</button>
            <button type="submit" class="btn btn-success">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Backups Tab -->
    <div id="backups-tab" class="tab-content">
      <div class="section">
        <div class="section-title">
          Backup Management
          <button class="btn btn-primary" onclick="loadBackups()" style="float: right;">Refresh</button>
        </div>

        <div id="backups-list">
          <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.5;">
            Click "Refresh" to load backups
          </div>
        </div>
      </div>
    </div>

    <!-- Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <div class="section">
        <div class="section-title">Recent Logs (Last 100 lines)</div>
        <div class="log-viewer" id="log-viewer">{{ logs }}</div>
        <div style="margin-top: 12px; text-align: center;">
          <button class="btn btn-primary" onclick="refreshLogs()">Refresh Logs</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit User Data</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>

      <form id="editUserForm" onsubmit="saveUserData(event)">
        <div class="form-group">
          <label class="form-label">User ID (Read-only)</label>
          <input type="text" id="edit-user-id" class="form-input" readonly>
        </div>

        <div class="form-group">
          <label class="form-label">User Data (JSON)</label>
          <textarea id="edit-user-data" class="form-textarea" placeholder='{"key": "value"}'></textarea>
          <small style="opacity: 0.6; font-size: 12px;">
            ‚ö†Ô∏è Be careful when editing JSON. Invalid JSON will be rejected.
          </small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-success">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notice Modal (Multi-language Support) -->
  <div id="noticeModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
      <div class="modal-header">
        <h2 class="modal-title" id="notice-modal-title">Create Notice</h2>
        <button class="close-btn" onclick="closeNoticeModal()">&times;</button>
      </div>

      <form id="noticeForm" onsubmit="saveNotice(event)">
        <input type="hidden" id="notice-id">

        <!-- Multi-language Content -->
        <div class="form-group">
          <label class="form-label">Notice Content (Multi-language)</label>

          <!-- Chinese -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">
              üá®üá≥ ‰∏≠Êñá
            </label>
            <textarea id="notice-content-zh" class="form-textarea" rows="4" placeholder="ËæìÂÖ•‰∏≠ÊñáÂÜÖÂÆπ..."></textarea>
          </div>

          <!-- Japanese -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">
              üáØüáµ Êó•Êú¨Ë™û
            </label>
            <textarea id="notice-content-ja" class="form-textarea" rows="4" placeholder="Êó•Êú¨Ë™û„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ..."></textarea>
          </div>

          <!-- English -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">
              üá∫üá∏ English
            </label>
            <textarea id="notice-content-en" class="form-textarea" rows="4" placeholder="Enter English content..."></textarea>
          </div>

          <small style="opacity: 0.6; font-size: 12px;">
            üí° At least one language is required. Unfilled languages will display the filled content.
          </small>
        </div>

        <!-- Voting Option -->
        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="notice-voting-enabled" style="width: auto;">
            Enable Voting (Support/Oppose)
          </label>
          <small style="opacity: 0.6; font-size: 12px; display: block; margin-top: 4px;">
            Allow users to vote "Support" or "Oppose" on this notice
          </small>
        </div>

        <!-- Button Configuration -->
        <div class="form-group">
          <label class="form-label" style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="notice-has-button" onchange="toggleNoticeButtonFields()" style="width: auto;">
            Add Button
          </label>
        </div>

        <div id="noticeButtonFields" style="display: none; border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; margin-bottom: 20px; background-color: var(--hover-bg);">
          <div class="form-group">
            <label class="form-label">Button Type:</label>
            <select id="notice-button-type" class="form-input">
              <option value="uri">Link (URI)</option>
              <option value="message">Message</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Button Label (Chinese):</label>
            <input type="text" id="notice-button-label-zh" class="form-input" placeholder="Êü•ÁúãËØ¶ÊÉÖ / Â∞ùËØï‰∏Ä‰∏ã">
          </div>

          <div class="form-group">
            <label class="form-label">Button Label (English):</label>
            <input type="text" id="notice-button-label-en" class="form-input" placeholder="View Details / Try it">
          </div>

          <div class="form-group">
            <label class="form-label">Button Label (Japanese):</label>
            <input type="text" id="notice-button-label-ja" class="form-input" placeholder="Ë©≥Á¥∞„ÇíË¶ã„Çã / Ë©¶„Åó„Å¶„Åø„Çã">
          </div>

          <div class="form-group">
            <label class="form-label">Button Value (URI or Message Text):</label>
            <input type="text" id="notice-button-value" class="form-input" placeholder="https://example.com or message text">
          </div>
        </div>

        <!-- Publication Status -->
        <div class="form-group">
          <label class="form-label">Publication Status</label>
          <select id="notice-status" class="form-input">
            <option value="published">Publish immediately</option>
            <option value="draft">Save as draft</option>
          </select>
          <small style="opacity: 0.6; font-size: 12px; display: block; margin-top: 4px;">
            Drafts are only visible to admins and won't be pushed to users
          </small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="closeNoticeModal()">Cancel</button>
          <button type="submit" class="btn btn-success" id="notice-save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notice Statistics Modal -->
  <div id="noticeStatsModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">Notice Statistics</h2>
        <button class="close-btn" onclick="closeStatsModal()">&times;</button>
      </div>

      <div id="stats-content" style="padding: 20px;">
        <!-- Statistics content will be dynamically generated -->
      </div>

      <div style="padding: 0 20px 20px;">
        <button class="btn btn-primary" onclick="closeStatsModal()">Close</button>
      </div>
    </div>
  </div>

  <script>
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');

      // Save to localStorage
      localStorage.setItem('admin_active_tab', tabName);

      // Â¶ÇÊûúÂàáÊç¢Âà∞logsÊ†áÁ≠æÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
      if (tabName === 'logs') {
        setTimeout(scrollLogsToBottom, 100);
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞noticesÊ†áÁ≠æÔºåÂä†ËΩΩÂÖ¨Âëä
      if (tabName === 'notices') {
        loadNotices();
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞tipadÊ†áÁ≠æÔºåÂä†ËΩΩtip/ad
      if (tabName === 'tipad') {
        loadTipAds();
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞backupsÊ†áÁ≠æÔºåÂä†ËΩΩÂ§á‰ªΩÂàóË°®
      if (tabName === 'backups') {
        loadBackups();
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞statsÊ†áÁ≠æÔºåÂä†ËΩΩÂÜÖÂ≠òÁªüËÆ°
      if (tabName === 'stats') {
        loadMemoryStats();
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞cacheÊ†áÁ≠æÔºåÂä†ËΩΩÁºìÂ≠òËøõÂ∫¶ÂíåDXDataÁä∂ÊÄÅ
      if (tabName === 'cache') {
        loadCacheProgress();
        loadDXDataStatus();
      }
    }

    // Restore tab on page load
    window.addEventListener('DOMContentLoaded', function() {
      const savedTab = localStorage.getItem('admin_active_tab');
      if (savedTab && document.getElementById(savedTab + '-tab')) {
        // Hide all tabs first
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Show saved tab
        document.getElementById(savedTab + '-tab').classList.add('active');
        document.querySelector('.tab[onclick*="' + savedTab + '"]').classList.add('active');

        // Â¶ÇÊûúÊÅ¢Â§çÁöÑÊòØlogsÊ†áÁ≠æÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
        if (savedTab === 'logs') {
          setTimeout(scrollLogsToBottom, 100);
        }
      }

      // ËΩ¨Êç¢Êó•Âøó‰∏≠ÁöÑ ANSI È¢úËâ≤‰ª£Á†Å
      const logViewer = document.getElementById('log-viewer');
      if (logViewer && logViewer.textContent) {
        const logText = logViewer.textContent;
        logViewer.innerHTML = ansiToHtml(logText);
      }

      // Â¶ÇÊûúÂΩìÂâçÊòæÁ§∫ÁöÑÊòØlogsÊ†áÁ≠æÔºàÈªòËÆ§ÊàñÊÅ¢Â§çÁöÑÔºâÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
      if (document.getElementById('logs-tab').classList.contains('active')) {
        setTimeout(scrollLogsToBottom, 100);
      }
    });

    function toggleUserData(userId) {
      const dataElement = document.getElementById('data-' + userId);
      const toggleIcon = document.getElementById('toggle-' + userId);

      if (dataElement.classList.contains('expanded')) {
        dataElement.classList.remove('expanded');
        toggleIcon.textContent = '‚ñº';
      } else {
        dataElement.classList.add('expanded');
        toggleIcon.textContent = '‚ñ≤';
      }
    }

    function triggerUpdate(userId) {
      if (confirm('Trigger maimai_update for user ' + userId + '?\n\nThe update will run in the background.')) {
        // Á¶ÅÁî®ÊåâÈíÆ,ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        const btn = event.target;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Queuing...';

        fetch('/admin/trigger_update', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: userId})
        })
        .then(res => res.json())
        .then(data => {
          // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ‰ΩÜ‰∏çÈáçËΩΩÈ°µÈù¢
          alert('‚úÖ ' + (data.message || 'Update task queued successfully!\n\nThe update is running in the background.\nYou will receive a notification when it completes.'));

          // ÊÅ¢Â§çÊåâÈíÆ
          btn.disabled = false;
          btn.textContent = originalText;
        })
        .catch(err => {
          alert('‚ùå Error: ' + err);
          btn.disabled = false;
          btn.textContent = originalText;
        });
      }
    }

    function refreshUserData(userId) {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Loading...';

      fetch('/admin/get_user_data', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Êõ¥Êñ∞ JSON ÊòæÁ§∫
          const jsonViewer = document.querySelector('#data-' + userId + ' .json-viewer pre');
          jsonViewer.textContent = data.json_str;

          // Êõ¥Êñ∞ÊòµÁß∞
          const nicknameElement = document.querySelector('[data-user-id="' + userId + '"] .user-nickname');
          nicknameElement.textContent = data.nickname;

          // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
          showToast('‚úÖ User data refreshed', 'success');
        } else {
          alert('‚ùå Error: ' + (data.message || 'Unknown error'));
        }

        btn.disabled = false;
        btn.textContent = originalText;
      })
      .catch(err => {
        alert('‚ùå Network error: ' + err);
        btn.disabled = false;
        btn.textContent = originalText;
      });
    }

    // ÁÆÄÂçïÁöÑ Toast ÈÄöÁü•
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    function editUser(userId) {
      // ‰ªéÈ°µÈù¢‰∏≠Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆ
      const userDataElement = document.getElementById('data-' + userId);
      const jsonStr = userDataElement.querySelector('pre').textContent;

      document.getElementById('edit-user-id').value = userId;
      document.getElementById('edit-user-data').value = jsonStr;
      document.getElementById('editUserModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editUserModal').classList.remove('show');
    }

    function saveUserData(event) {
      event.preventDefault();

      const userId = document.getElementById('edit-user-id').value;
      const userDataStr = document.getElementById('edit-user-data').value;

      // Validate JSON
      try {
        const userData = JSON.parse(userDataStr);

        if (!confirm('Save changes for user ' + userId + '?')) {
          return;
        }

        fetch('/admin/edit_user', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: userId,
            user_data: userData
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ User data saved successfully!');
            closeEditModal();
            location.reload();
          } else {
            alert('‚ùå Error: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(err => {
          alert('‚ùå Network error: ' + err);
        });
      } catch (e) {
        alert('‚ùå Invalid JSON format!\n\n' + e.message);
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('editUserModal');
      if (event.target === modal) {
        closeEditModal();
      }
    }

    function deleteUser(userId) {
      if (confirm('‚ö†Ô∏è Are you sure you want to delete this user?\n\nUser ID: ' + userId + '\n\nThis action CANNOT be undone!')) {
        const button = event.target;
        button.disabled = true;
        button.textContent = 'Deleting...';

        fetch('/admin/delete_user', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: userId})
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('‚úì User deleted successfully');
            // ÁßªÈô§Áî®Êà∑ÂÖÉÁ¥†
            const userElement = document.querySelector('[data-user-id="' + userId + '"]');
            if (userElement) {
              userElement.style.opacity = '0';
              userElement.style.transition = 'opacity 0.3s';
              setTimeout(() => userElement.remove(), 300);
            }
          } else {
            showToast('‚úó ' + (data.message || 'Failed to delete user'));
            button.disabled = false;
            button.textContent = 'Delete';
          }
        })
        .catch(err => {
          showToast('‚úó Error: ' + err);
          button.disabled = false;
          button.textContent = 'Delete';
        });
      }
    }

    function cancelTask(taskId) {
      if (confirm('Cancel this task?')) {
        const button = event.target;
        button.disabled = true;
        button.textContent = 'Cancelling...';

        fetch('/admin/cancel_task', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({task_id: taskId})
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('‚úì Task cancelled successfully');
            // Âà∑Êñ∞È°µÈù¢‰ª•Êõ¥Êñ∞‰ªªÂä°ÂàóË°®
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast('‚úó ' + (data.message || 'Failed to cancel task'));
            button.disabled = false;
            button.textContent = 'Cancel';
          }
        })
        .catch(err => {
          showToast('‚úó Error: ' + err);
          button.disabled = false;
          button.textContent = 'Cancel';
        });
      }
    }

    function filterUsers() {
      const searchTerm = document.getElementById('user-search').value.toLowerCase();
      const userItems = document.querySelectorAll('.user-item');

      userItems.forEach(item => {
        const userId = item.dataset.userId.toLowerCase();
        const nickname = item.dataset.nickname;

        if (userId.includes(searchTerm) || nickname.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function scrollLogsToBottom() {
      const logViewer = document.getElementById('log-viewer');
      if (logViewer) {
        logViewer.scrollTop = logViewer.scrollHeight;
      }
    }

    function ansiToHtml(text) {
      // ANSI È¢úËâ≤‰ª£Á†ÅÊò†Â∞Ñ
      const colors = {
        '30': '#000000', '31': '#cd3131', '32': '#0dbc79', '33': '#e5e510',
        '34': '#2472c8', '35': '#bc3fbc', '36': '#11a8cd', '37': '#e5e5e5',
        '90': '#666666', '91': '#f14c4c', '92': '#23d18b', '93': '#f5f543',
        '94': '#3b8eea', '95': '#d670d6', '96': '#29b8db', '97': '#ffffff',
        '40': '#000000', '41': '#cd3131', '42': '#0dbc79', '43': '#e5e510',
        '44': '#2472c8', '45': '#bc3fbc', '46': '#11a8cd', '47': '#e5e5e5'
      };

      let html = '';
      let currentStyle = '';

      // ËΩ¨‰πâ HTML ÁâπÊÆäÂ≠óÁ¨¶
      text = text.replace(/&/g, '&amp;')
                 .replace(/</g, '&lt;')
                 .replace(/>/g, '&gt;');

      // Ëß£Êûê ANSI ‰ª£Á†Å
      const parts = text.split(/\x1b\[([0-9;]+)m/);

      for (let i = 0; i < parts.length; i++) {
        if (i % 2 === 0) {
          // ÊñáÊú¨ÈÉ®ÂàÜ
          if (currentStyle) {
            html += '<span style="' + currentStyle + '">' + parts[i] + '</span>';
          } else {
            html += parts[i];
          }
        } else {
          // ANSI ‰ª£Á†ÅÈÉ®ÂàÜ
          const codes = parts[i].split(';');
          let styles = [];

          for (const code of codes) {
            if (code === '0' || code === '') {
              // ÈáçÁΩÆ
              currentStyle = '';
            } else if (code === '1') {
              // Á≤ó‰Ωì
              styles.push('font-weight: bold');
            } else if (code === '4') {
              // ‰∏ãÂàíÁ∫ø
              styles.push('text-decoration: underline');
            } else if (colors[code]) {
              // ÂâçÊôØËâ≤
              if (code.startsWith('3') || code.startsWith('9')) {
                styles.push('color: ' + colors[code]);
              }
              // ËÉåÊôØËâ≤
              else if (code.startsWith('4')) {
                styles.push('background-color: ' + colors[code]);
              }
            }
          }

          currentStyle = styles.join('; ');
        }
      }

      return html;
    }

    function refreshLogs() {
      fetch('/admin/get_logs')
        .then(res => res.json())
        .then(data => {
          const logViewer = document.getElementById('log-viewer');
          // ‰ΩøÁî® innerHTML ËÄå‰∏çÊòØ textContent Êù•ÊîØÊåÅ HTML
          logViewer.innerHTML = ansiToHtml(data.logs);
          // ÊªöÂä®Âà∞Â∫ïÈÉ®
          scrollLogsToBottom();
        })
        .catch(err => alert('Error refreshing logs: ' + err));
    }

    function refreshTasks() {
      // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢‰ª•Âà∑Êñ∞‰ªªÂä°ÂàóË°®
      location.reload();
    }

    function clearNicknameCache() {
      if (confirm('Clear nickname cache? This will force a refresh from LINE API on next load.')) {
        fetch('/admin/clear_cache', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Nickname cache cleared! Refresh the page to reload nicknames.');
          } else {
            alert('‚ùå Error: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(err => alert('‚ùå Network error: ' + err));
      }
    }

    // Auto-refresh task queue every 10 seconds
    setInterval(() => {
      if (document.getElementById('tasks-tab').classList.contains('active')) {
        location.reload();
      }
    }, 10000);

    // Lazy load nicknames after page loads
    window.addEventListener('DOMContentLoaded', function() {
      loadAllNicknames();
    });

    function updateTaskNicknames(userId, nickname) {
      // Êõ¥Êñ∞‰ªªÂä°ÈòüÂàó‰∏≠ÊâÄÊúâÂåÖÂê´ËØ•Áî®Êà∑IDÁöÑÊòµÁß∞
      const taskUserElements = document.querySelectorAll('.task-user');
      taskUserElements.forEach(element => {
        const text = element.textContent;
        // ÂåπÈÖç "User: {userId} (Loading...)" Êàñ "User: {userId} ({‰ªª‰ΩïÊòµÁß∞})"
        const regex = new RegExp('User: ' + userId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ' \\(.*?\\)');
        if (regex.test(text)) {
          element.textContent = 'User: ' + userId + ' (' + nickname + ')';
        }
      });
    }

    function loadAllNicknames() {
      fetch('/admin/load_nicknames', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
          const loadingIndicator = document.getElementById('nickname-loading');
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }

          // Êõ¥Êñ∞ÊâÄÊúâÁî®Êà∑ÁöÑÊòµÁß∞
          const nicknames = data.nicknames;
          for (const userId in nicknames) {
            const nicknameElement = document.querySelector('[data-user-id="' + userId + '"] .user-nickname');
            if (nicknameElement) {
              nicknameElement.textContent = nicknames[userId];
            }

            // Êõ¥Êñ∞ÊêúÁ¥¢Áî®ÁöÑ data Â±ûÊÄß
            const userItem = document.querySelector('[data-user-id="' + userId + '"]');
            if (userItem) {
              userItem.setAttribute('data-nickname', nicknames[userId].toLowerCase());
            }

            // Êõ¥Êñ∞‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑÊòµÁß∞
            updateTaskNicknames(userId, nicknames[userId]);
          }

          console.log('Loaded ' + data.count + ' nicknames');
        } else {
          console.error('Failed to load nicknames:', data.message);
          // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®Âç≥‰ΩøÂ§±Ë¥•
          const loadingIndicator = document.getElementById('nickname-loading');
          if (loadingIndicator) {
            loadingIndicator.innerHTML = '<span style="color: var(--danger-color);">‚ö†Ô∏è Failed to load nicknames</span>';
          }
        }
      })
      .catch(err => {
        console.error('Error loading nicknames:', err);
        const loadingIndicator = document.getElementById('nickname-loading');
        if (loadingIndicator) {
          loadingIndicator.innerHTML = '<span style="color: var(--danger-color);">‚ö†Ô∏è Network error</span>';
        }
      });
    }

    // ==================== Notice Management Functions ====================

    function loadNotices() {
      fetch('/admin/get_notices')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayNotices(data.notices);
          } else {
            showToast('‚úó Failed to load notices: ' + data.message);
          }
        })
        .catch(err => {
          showToast('‚úó Network error: ' + err);
        });
    }

    function displayNotices(notices) {
      const container = document.getElementById('notices-list');

      if (!notices || notices.length === 0) {
        container.innerHTML = '<div class="empty-state">No notices found</div>';
        return;
      }

      container.innerHTML = '';

      for (const notice of notices) {
        const noticeItem = document.createElement('div');
        noticeItem.className = 'task-item';
        noticeItem.style.marginBottom = '16px';

        // Status badge
        const statusBadge = document.createElement('span');
        statusBadge.style.cssText = 'padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 8px; display: inline-block;';
        if (notice.status === 'draft') {
          statusBadge.textContent = 'Draft';
          statusBadge.style.backgroundColor = '#FFF3CD';
          statusBadge.style.color = '#856404';
        } else {
          statusBadge.textContent = 'Published';
          statusBadge.style.backgroundColor = '#D4EDDA';
          statusBadge.style.color = '#155724';
        }

        // Voting badge
        const votingBadge = document.createElement('span');
        if (notice.voting_enabled) {
          votingBadge.style.cssText = 'padding: 2px 8px; border-radius: 4px; font-size: 11px; background-color: #D1ECF1; color: #0C5460; margin-right: 8px; display: inline-block;';
          votingBadge.textContent = 'Voting';
        }

        // Content preview (show Chinese content, truncate)
        const contentPreview = (typeof notice.content === 'string'
          ? notice.content
          : notice.content.zh || notice.content.jp || notice.content.en || '').substring(0, 100) + '...';

        const taskInfo = document.createElement('div');
        taskInfo.className = 'task-info';
        taskInfo.style.flex = '1';

        taskInfo.innerHTML = `
          ${statusBadge.outerHTML}
          ${notice.voting_enabled ? votingBadge.outerHTML : ''}
          <div style="font-weight: 600; margin-bottom: 8px; margin-top: 4px;">
            ${escapeHtml(contentPreview)}
          </div>
          <div style="font-size: 11px; opacity: 0.5;">
            ID: ${notice.id} | Created: ${notice.date}
          </div>
        `;

        // Actions
        const actions = document.createElement('div');
        actions.style.display = 'flex';
        actions.style.gap = '8px';

        // Stats button (only for published)
        if (notice.status === 'published') {
          const statsBtn = document.createElement('button');
          statsBtn.className = 'btn btn-primary';
          statsBtn.textContent = 'Stats';
          statsBtn.onclick = () => showNoticeStats(notice.id);
          actions.appendChild(statsBtn);
        }

        // Publish button (only for drafts)
        if (notice.status === 'draft') {
          const publishBtn = document.createElement('button');
          publishBtn.className = 'btn btn-success';
          publishBtn.textContent = 'Publish';
          publishBtn.onclick = () => publishDraft(notice.id);
          actions.appendChild(publishBtn);
        }

        // Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-primary';
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => editNotice(notice.id);
        actions.appendChild(editBtn);

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteNoticeConfirm(notice.id);
        actions.appendChild(deleteBtn);

        noticeItem.appendChild(taskInfo);
        noticeItem.appendChild(actions);
        container.appendChild(noticeItem);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function toggleNoticeButtonFields() {
      const hasButton = document.getElementById('notice-has-button').checked;
      document.getElementById('noticeButtonFields').style.display = hasButton ? 'block' : 'none';
    }

    function showCreateNoticeModal() {
      document.getElementById('notice-modal-title').textContent = 'Create New Notice';
      document.getElementById('notice-id').value = '';
      document.getElementById('notice-content-zh').value = '';
      document.getElementById('notice-content-ja').value = '';
      document.getElementById('notice-content-en').value = '';
      document.getElementById('notice-voting-enabled').checked = false;
      document.getElementById('notice-status').value = 'published';
      document.getElementById('notice-has-button').checked = false;
      document.getElementById('noticeButtonFields').style.display = 'none';
      document.getElementById('notice-button-type').value = 'uri';
      document.getElementById('notice-button-label-zh').value = '';
      document.getElementById('notice-button-label-ja').value = '';
      document.getElementById('notice-button-label-en').value = '';
      document.getElementById('notice-button-value').value = '';
      document.getElementById('notice-save-btn').textContent = 'Create';
      document.getElementById('noticeModal').style.display = 'block';
    }

    function editNotice(noticeId) {
      fetch('/admin/get_notices')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const notice = data.notices.find(n => n.id === noticeId);
            if (notice) {
              document.getElementById('notice-modal-title').textContent = 'Edit Notice';
              document.getElementById('notice-id').value = notice.id;

              // Handle multi-language content
              const content = notice.content;
              if (typeof content === 'string') {
                // Backward compatibility
                document.getElementById('notice-content-zh').value = content;
                document.getElementById('notice-content-ja').value = '';
                document.getElementById('notice-content-en').value = '';
              } else {
                document.getElementById('notice-content-zh').value = content.zh || '';
                document.getElementById('notice-content-ja').value = content.ja || '';
                document.getElementById('notice-content-en').value = content.en || '';
              }

              document.getElementById('notice-voting-enabled').checked = notice.voting_enabled || false;
              document.getElementById('notice-status').value = notice.status || 'published';

              // Load button data
              if (notice.button) {
                document.getElementById('notice-has-button').checked = true;
                document.getElementById('noticeButtonFields').style.display = 'block';
                document.getElementById('notice-button-type').value = notice.button.type || 'uri';
                document.getElementById('notice-button-label-zh').value = notice.button.label?.zh || '';
                document.getElementById('notice-button-label-ja').value = notice.button.label?.ja || '';
                document.getElementById('notice-button-label-en').value = notice.button.label?.en || '';
                document.getElementById('notice-button-value').value = notice.button.value || '';
              } else {
                document.getElementById('notice-has-button').checked = false;
                document.getElementById('noticeButtonFields').style.display = 'none';
              }

              document.getElementById('notice-save-btn').textContent = 'Update';
              document.getElementById('noticeModal').style.display = 'block';
            }
          }
        });
    }

    function saveNotice(event) {
      event.preventDefault();

      const noticeId = document.getElementById('notice-id').value;
      const contentZh = document.getElementById('notice-content-zh').value.trim();
      const contentJa = document.getElementById('notice-content-ja').value.trim();
      const contentEn = document.getElementById('notice-content-en').value.trim();
      const votingEnabled = document.getElementById('notice-voting-enabled').checked;
      const status = document.getElementById('notice-status').value;

      // Validate at least one language
      if (!contentJa && !contentEn && !contentZh) {
        showToast('‚úó At least one language content is required');
        return;
      }

      const isUpdate = !!noticeId;
      const url = isUpdate ? '/admin/update_notice' : '/admin/create_notice';
      const payload = {
        content_ja: contentJa,
        content_en: contentEn,
        content_zh: contentZh,
        voting_enabled: votingEnabled,
        status: status
      };

      if (isUpdate) {
        payload.notice_id = noticeId;
      }

      // Add button data
      const hasButton = document.getElementById('notice-has-button').checked;
      if (hasButton) {
        payload.button_type = document.getElementById('notice-button-type').value;
        payload.button_label_zh = document.getElementById('notice-button-label-zh').value;
        payload.button_label_ja = document.getElementById('notice-button-label-ja').value;
        payload.button_label_en = document.getElementById('notice-button-label-en').value;
        payload.button_value = document.getElementById('notice-button-value').value;
      } else if (isUpdate) {
        payload.remove_button = true;
      }

      const btn = document.getElementById('notice-save-btn');
      btn.disabled = true;
      btn.textContent = isUpdate ? 'Updating...' : 'Creating...';

      fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast(`‚úì Notice ${isUpdate ? 'updated' : 'created'} successfully`);
          closeNoticeModal();
          loadNotices();
        } else {
          showToast('‚úó ' + data.message);
        }
        btn.disabled = false;
        btn.textContent = isUpdate ? 'Update' : 'Create';
      })
      .catch(err => {
        showToast('‚úó Network error: ' + err);
        btn.disabled = false;
        btn.textContent = isUpdate ? 'Update' : 'Create';
      });
    }

    function deleteNoticeConfirm(noticeId) {
      if (!confirm('Are you sure you want to delete this notice?\n\nThis action cannot be undone.')) {
        return;
      }

      fetch('/admin/delete_notice', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({notice_id: noticeId})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('‚úì Notice deleted successfully');
          loadNotices();
        } else {
          showToast('‚úó ' + data.message);
        }
      })
      .catch(err => {
        showToast('‚úó Network error: ' + err);
      });
    }

    function closeNoticeModal() {
      document.getElementById('noticeModal').style.display = 'none';
      document.getElementById('noticeForm').reset();
    }

    function showNoticeStats(noticeId) {
      fetch(`/admin/get_notice_stats?notice_id=${noticeId}`)
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayNoticeStats(data.stats);
            document.getElementById('noticeStatsModal').style.display = 'block';
          } else {
            showToast('‚úó Failed to load statistics');
          }
        })
        .catch(err => {
          showToast('‚úó Network error: ' + err);
        });
    }

    function displayNoticeStats(stats) {
      const container = document.getElementById('stats-content');

      const supportPct = stats.support_count + stats.oppose_count > 0
        ? (stats.support_count / (stats.support_count + stats.oppose_count) * 100).toFixed(1)
        : 0;
      const opposePct = stats.support_count + stats.oppose_count > 0
        ? (stats.oppose_count / (stats.support_count + stats.oppose_count) * 100).toFixed(1)
        : 0;

      container.innerHTML = `
        <div style="margin-bottom: 24px;">
          <h3 style="font-size: 14px; color: #666; margin-bottom: 12px;">üìñ Read Statistics</h3>
          <div style="padding: 16px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Total Users:</span>
              <strong>${stats.total_users}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Read Count:</span>
              <strong style="color: #17B169;">${stats.read_count}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Read Percentage:</span>
              <strong style="color: #17B169;">${stats.read_percentage}%</strong>
            </div>

            <!-- Progress bar -->
            <div style="margin-top: 12px; background: #E9ECEF; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="width: ${stats.read_percentage}%; height: 100%; background: linear-gradient(90deg, #17B169, #28C76F); transition: width 0.3s;"></div>
            </div>
          </div>
        </div>

        <div>
          <h3 style="font-size: 14px; color: #666; margin-bottom: 12px;">üó≥Ô∏è Voting Statistics</h3>
          <div style="padding: 16px; border-radius: 8px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Support:</span>
              <strong style="color: #17B169;">${stats.support_count} (${supportPct}%)</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>Oppose:</span>
              <strong style="color: #FF3B30;">${stats.oppose_count} (${opposePct}%)</strong>
            </div>
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span>No Vote:</span>
              <strong style="color: #999;">${stats.no_vote_count}</strong>
            </div>
            <div style="display: flex; justify-content: space-between;">
              <span>Vote Participation:</span>
              <strong>${stats.vote_percentage}%</strong>
            </div>

            <!-- Vote visualization -->
            <div style="margin-top: 12px; display: flex; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="width: ${supportPct}%; background: #17B169;"></div>
              <div style="width: ${opposePct}%; background: #FF3B30;"></div>
            </div>
          </div>
        </div>
      `;
    }

    function closeStatsModal() {
      document.getElementById('noticeStatsModal').style.display = 'none';
    }

    function publishDraft(noticeId) {
      if (!confirm('Are you sure you want to publish this draft?\n\nThis will send the notice to all users.')) {
        return;
      }

      fetch('/admin/publish_notice', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({notice_id: noticeId})
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('‚úì Notice published successfully');
            loadNotices();
          } else {
            showToast('‚úó ' + data.message);
          }
        })
        .catch(err => {
          showToast('‚úó Network error: ' + err);
        });
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const noticeModal = document.getElementById('noticeModal');
      if (event.target === noticeModal) {
        closeNoticeModal();
      }
    }

    // Load notices when notices tab is opened
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('notices-tab').classList.contains('active')) {
        loadNotices();
      }

      // Load memory stats if on stats tab
      if (document.getElementById('stats-tab').classList.contains('active')) {
        loadMemoryStats();
      }
    });

    // ==================== Memory Management Functions ====================

    function loadMemoryStats() {
      const container = document.getElementById('memory-stats-container');
      container.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.5;">Loading...</div>';

      fetch('/admin/memory_stats')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayMemoryStats(data.stats);
          } else {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger-color);">Failed to load memory stats</div>';
          }
        })
        .catch(err => {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger-color);">Network error: ' + err + '</div>';
        });
    }

    function displayMemoryStats(stats) {
      const container = document.getElementById('memory-stats-container');

      const html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Status</div>
            <div style="font-size: 24px; font-weight: 700; color: ${stats.running ? 'var(--success-color)' : 'var(--danger-color)'}; margin-bottom: 4px;">
              ${stats.running ? 'Running' : 'Stopped'}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Memory Manager</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Interval</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${stats.interval_seconds}<span style="font-size: 18px; opacity: 0.5; margin-left: 4px;">s</span>
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Cleanup interval</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Last Cleanup</div>
            <div style="font-size: 16px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${stats.last_cleanup}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Last run time</div>
          </div>
        </div>

        <div style="padding: 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
          <div style="font-size: 12px; font-weight: 600; opacity: 0.7; margin-bottom: 12px;">Garbage Collector Statistics</div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
            <div>
              <div style="font-size: 11px; opacity: 0.5; margin-bottom: 4px;">Gen 0 Count</div>
              <div style="font-size: 20px; font-weight: 600;">${stats.gc_counts[0]}</div>
            </div>
            <div>
              <div style="font-size: 11px; opacity: 0.5; margin-bottom: 4px;">Gen 1 Count</div>
              <div style="font-size: 20px; font-weight: 600;">${stats.gc_counts[1]}</div>
            </div>
            <div>
              <div style="font-size: 11px; opacity: 0.5; margin-bottom: 4px;">Gen 2 Count</div>
              <div style="font-size: 20px; font-weight: 600;">${stats.gc_counts[2]}</div>
            </div>
          </div>

          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
            <div style="font-size: 11px; opacity: 0.5; margin-bottom: 8px;">GC Thresholds</div>
            <div style="font-size: 13px; font-family: 'Courier New', monospace;">
              Gen 0: ${stats.gc_threshold[0]} | Gen 1: ${stats.gc_threshold[1]} | Gen 2: ${stats.gc_threshold[2]}
            </div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    function triggerMemoryCleanup() {
      if (!confirm('Trigger manual memory cleanup?\n\nThis will run garbage collection and clear expired caches.')) {
        return;
      }

      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Cleaning...';

      fetch('/admin/trigger_cleanup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('‚úì Memory cleanup completed: ' + data.stats.collected_objects + ' objects collected in ' + data.stats.elapsed_ms + 'ms');
          // Reload stats
          setTimeout(() => loadMemoryStats(), 500);
        } else {
          showToast('‚úó Cleanup failed: ' + data.message);
        }
        btn.disabled = false;
        btn.textContent = originalText;
      })
      .catch(err => {
        showToast('‚úó Network error: ' + err);
        btn.disabled = false;
        btn.textContent = originalText;
      });
    }

    // ==================== DxData Functions ====================

    function loadDXDataStatus() {
      const container = document.getElementById('dxdata-status-container');
      container.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.5;">Loading...</div>';

      fetch('/admin/dxdata_status')
        .then(res => res.json())
        .then(data => {
          displayDXDataStatus(data);
        })
        .catch(err => {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger-color);">Network error: ' + err + '</div>';
        });
    }

    function displayDXDataStatus(data) {
      const container = document.getElementById('dxdata-status-container');

      const html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Total Songs</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${data.songs.total}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">All songs in database</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Standard Songs</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${data.songs.std}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">STD type songs</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">DX Songs</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${data.songs.dx}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">DX type songs</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">UTAGE Songs</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${data.songs.utage}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">UTAGE type songs</div>
          </div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px;">
          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Total Sheets</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${data.sheets.total}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">All difficulty charts</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">JP Sheets</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${data.sheets.jp}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Available in JP</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">INTL Sheets</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${data.sheets.intl}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Available in INTL</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Versions</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${data.versions}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Game versions</div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    // ========== Backup Management ==========
    function loadBackups() {
      const listEl = document.getElementById('backups-list');
      listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-tertiary);">Loading backups...</div>';

      fetch('/admin/get_backups')
        .then(res => res.json())
        .then(data => {
          if (!data.success) {
            listEl.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--danger-color);">Error: ${data.message}</div>`;
            return;
          }

          if (data.backups.length === 0) {
            listEl.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-tertiary);">No backup files found</div>';
            return;
          }

          displayBackups(data.backups);
        })
        .catch(err => {
          listEl.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--danger-color);">Network error: ${err}</div>`;
        });
    }

    function displayBackups(backups) {
      const listEl = document.getElementById('backups-list');

      if (backups.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No backup files found.</div>';
        return;
      }

      let html = '<table style="width: 100%; border-collapse: collapse;">';
      html += `
        <thead>
          <tr style="border-bottom: 2px solid var(--border-color);">
            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-color);">Filename</th>
            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-color);">Size</th>
            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-color);">Created At</th>
            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-color);">Actions</th>
          </tr>
        </thead>
        <tbody>
      `;

      backups.forEach(backup => {
        html += `
          <tr style="border-bottom: 1px solid var(--border-color); transition: background-color 0.2s;">
            <td style="padding: 12px;">
              <div style="font-family: 'Courier New', monospace; font-size: 13px; color: var(--accent-color); font-weight: 500;">${backup.filename}</div>
            </td>
            <td style="padding: 12px; text-align: right;">
              <span style="color: var(--text-tertiary); font-size: 13px;">${backup.size_mb} MB</span>
            </td>
            <td style="padding: 12px; text-align: right;">
              <span style="color: var(--text-tertiary); font-size: 13px;">${backup.created_at}</span>
            </td>
            <td style="padding: 12px; text-align: right;">
              <button onclick="downloadBackup('${backup.filename}')" class="btn btn-primary" style="margin-right: 8px;">
                Download
              </button>
              <button onclick="deleteBackup('${backup.filename}')" class="btn btn-danger">
                Delete
              </button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      listEl.innerHTML = html;
    }

    function downloadBackup(filename) {
      window.location.href = `/admin/download_backup?file=${encodeURIComponent(filename)}`;
      showToast('Downloading ' + filename);
    }

    function deleteBackup(filename) {
      if (!confirm(`Are you sure you want to delete this backup?\n\n${filename}\n\nThis action cannot be undone.`)) {
        return;
      }

      fetch('/admin/delete_backup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({filename: filename})
      })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('‚úì Backup deleted successfully');
            loadBackups(); // Reload the list
          } else {
            showToast('‚úó ' + data.message);
          }
        })
        .catch(err => {
          showToast('‚úó Network error: ' + err);
        });
    }

    // ==================== Tip/Ad Management Functions ====================

    function loadTipAds() {
      fetch('/admin/get_tip_ads')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayTipAds(data.tip_ads);
          } else {
            showToast('‚úó Failed to load tip/ads');
          }
        })
        .catch(err => {
          showToast('‚úó Network error: ' + err);
        });
    }

    function displayTipAds(tipads) {
      const container = document.getElementById('tipadList');
      if (tipads.length === 0) {
        container.innerHTML = '<div class="empty-state">No tip/ads found. Create one to get started!</div>';
        return;
      }

      let html = '<div style="display: grid; gap: 12px;">';
      tipads.forEach(tipad => {
        const typeIcon = tipad.type === 'ad' ? 'üì¢' : 'üí°';
        const typeColor = tipad.type === 'ad' ? '#FF9500' : '#5856D6';
        const statusBadge = tipad.enabled
          ? '<span class="badge badge-success">Enabled</span>'
          : '<span class="badge badge-secondary">Disabled</span>';

        html += `
          <div class="user-item" style="background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
              <div>
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 6px;">
                  <span style="font-size: 20px;">${typeIcon}</span>
                  <span style="color: ${typeColor}; font-weight: 600; text-transform: uppercase; font-size: 14px;">${tipad.type}</span>
                  ${statusBadge}
                </div>
                <div style="color: var(--text-tertiary); font-size: 11px; font-family: 'Courier New', monospace;">
                  ID: ${tipad.id} | Created: ${tipad.created_at}
                </div>
              </div>
              <div class="user-actions">
                <button class="btn btn-warning" onclick="editTipAd('${tipad.id}')">Edit</button>
                <button class="btn btn-danger" onclick="deleteTipAd('${tipad.id}')">Delete</button>
              </div>
            </div>

            <div style="margin-bottom: 12px;">
              <div style="font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--text-color); opacity: 0.7;">üá®üá≥ Chinese:</div>
              <div style="padding: 8px 12px; background: var(--hover-bg); border-radius: 6px; margin-bottom: 8px; font-size: 13px; color: var(--text-color);">${tipad.text.zh || 'N/A'}</div>

              <div style="font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--text-color); opacity: 0.7;">üá¨üáß English:</div>
              <div style="padding: 8px 12px; background: var(--hover-bg); border-radius: 6px; margin-bottom: 8px; font-size: 13px; color: var(--text-color);">${tipad.text.en || 'N/A'}</div>

              <div style="font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--text-color); opacity: 0.7;">üáØüáµ Japanese:</div>
              <div style="padding: 8px 12px; background: var(--hover-bg); border-radius: 6px; font-size: 13px; color: var(--text-color);">${tipad.text.ja || 'N/A'}</div>
            </div>

            ${tipad.button ? `
              <div style="border-top: 1px solid var(--border-color); padding-top: 12px;">
                <div style="font-size: 11px; font-weight: 600; margin-bottom: 6px; color: var(--text-color); opacity: 0.7;">Button Settings:</div>
                <div style="background: var(--hover-bg); padding: 10px; border-radius: 6px; font-size: 12px;">
                  <div style="margin-bottom: 4px; color: var(--text-color);"><strong>Type:</strong> ${tipad.button.type}</div>
                  <div style="margin-bottom: 4px; color: var(--text-color);"><strong>Label (ZH):</strong> ${tipad.button.label.zh} ‚Üí</div>
                  <div style="margin-bottom: 4px; color: var(--text-color);"><strong>Label (EN):</strong> ${tipad.button.label.en} ‚Üí</div>
                  <div style="margin-bottom: 4px; color: var(--text-color);"><strong>Label (JA):</strong> ${tipad.button.label.ja} ‚Üí</div>
                  <div style="color: var(--text-color);"><strong>Value:</strong> ${tipad.button.value}</div>
                </div>
              </div>
            ` : '<div style="color: var(--text-tertiary); font-style: italic; border-top: 1px solid var(--border-color); padding-top: 10px; font-size: 12px;">No button configured</div>'}
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    function showCreateTipAdForm() {
      document.getElementById('tipadFormTitle').textContent = 'Create Tip/Ad';
      document.getElementById('tipadForm').reset();
      document.getElementById('tipad_id').value = '';
      document.getElementById('tipad_enabled').checked = true;
      document.getElementById('tipad_has_button').checked = false;
      document.getElementById('buttonFields').style.display = 'none';
      document.getElementById('tipadFormModal').classList.add('show');
    }

    function editTipAd(tipId) {
      fetch('/admin/get_tip_ads')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const tipad = data.tip_ads.find(t => t.id === tipId);
            if (tipad) {
              document.getElementById('tipadFormTitle').textContent = 'Edit Tip/Ad';
              document.getElementById('tipad_id').value = tipad.id;
              document.getElementById('tipad_type').value = tipad.type;
              document.getElementById('tipad_text_zh').value = tipad.text.zh || '';
              document.getElementById('tipad_text_en').value = tipad.text.en || '';
              document.getElementById('tipad_text_ja').value = tipad.text.ja || '';
              document.getElementById('tipad_enabled').checked = tipad.enabled;

              if (tipad.button) {
                document.getElementById('tipad_has_button').checked = true;
                document.getElementById('buttonFields').style.display = 'block';
                document.getElementById('tipad_button_type').value = tipad.button.type;
                document.getElementById('tipad_button_label_zh').value = tipad.button.label.zh || '';
                document.getElementById('tipad_button_label_en').value = tipad.button.label.en || '';
                document.getElementById('tipad_button_label_ja').value = tipad.button.label.ja || '';
                document.getElementById('tipad_button_value').value = tipad.button.value || '';
              } else {
                document.getElementById('tipad_has_button').checked = false;
                document.getElementById('buttonFields').style.display = 'none';
              }

              document.getElementById('tipadFormModal').classList.add('show');
            }
          }
        })
        .catch(err => {
          showToast('‚úó Failed to load tip/ad: ' + err);
        });
    }

    function closeTipAdForm() {
      document.getElementById('tipadFormModal').classList.remove('show');
    }

    function toggleButtonFields() {
      const hasButton = document.getElementById('tipad_has_button').checked;
      document.getElementById('buttonFields').style.display = hasButton ? 'block' : 'none';
    }

    function saveTipAd(event) {
      event.preventDefault();

      const tipId = document.getElementById('tipad_id').value;
      const hasButton = document.getElementById('tipad_has_button').checked;

      const data = {
        type: document.getElementById('tipad_type').value,
        text_zh: document.getElementById('tipad_text_zh').value,
        text_en: document.getElementById('tipad_text_en').value,
        text_ja: document.getElementById('tipad_text_ja').value,
        enabled: document.getElementById('tipad_enabled').checked
      };

      if (tipId) {
        data.id = tipId;
      }

      if (hasButton) {
        data.button_type = document.getElementById('tipad_button_type').value;
        data.button_label_zh = document.getElementById('tipad_button_label_zh').value;
        data.button_label_en = document.getElementById('tipad_button_label_en').value;
        data.button_label_ja = document.getElementById('tipad_button_label_ja').value;
        data.button_value = document.getElementById('tipad_button_value').value;
      } else if (tipId) {
        data.remove_button = true;
      }

      const url = tipId ? '/admin/update_tip_ad' : '/admin/create_tip_ad';

      fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('‚úì Tip/Ad saved successfully');
            closeTipAdForm();
            loadTipAds();
          } else {
            showToast('‚úó ' + data.message);
          }
        })
        .catch(err => {
          showToast('‚úó Network error: ' + err);
        });
    }

    function deleteTipAd(tipId) {
      if (!confirm('Are you sure you want to delete this tip/ad?')) {
        return;
      }

      fetch('/admin/delete_tip_ad', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({id: tipId})
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('‚úì Tip/Ad deleted successfully');
            loadTipAds();
          } else {
            showToast('‚úó ' + data.message);
          }
        })
        .catch(err => {
          showToast('‚úó Network error: ' + err);
        });
    }

    // Auto-refresh cache progress every 30 seconds when on cache tab
    setInterval(() => {
      if (document.getElementById('cache-tab').classList.contains('active')) {
        loadCacheProgress();
      }
    }, 30000);
  </script>
</body>
</html>
