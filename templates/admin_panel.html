<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel | JiETNG</title>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #222222;
      --border-color: #cccccc;
      --accent-color: #000000;
      --card-bg: #f9f9f9;
      --hover-bg: #f0f0f0;
      --success-color: #28a745;
      --warning-color: #ffc107;
      --danger-color: #dc3545;
      --info-color: #17a2b8;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg-color: #000000;
        --text-color: #eeeeee;
        --border-color: #555555;
        --accent-color: #ffffff;
        --card-bg: #1a1a1a;
        --hover-bg: #222222;
        --success-color: #4caf50;
        --warning-color: #ffeb3b;
        --danger-color: #ff6b6b;
        --info-color: #29b6f6;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: "Helvetica Neue", "Yu Gothic", "Meiryo", sans-serif;
      padding: 20px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: var(--accent-color);
    }

    .logout-btn {
      padding: 10px 20px;
      background-color: var(--danger-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .logout-btn:hover {
      opacity: 0.9;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-color);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      opacity: 0.6;
    }

    .tab.active {
      opacity: 1;
      border-bottom-color: var(--accent-color);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .section {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border-color);
    }

    .user-list {
      display: grid;
      gap: 12px;
    }

    .user-item {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      transition: all 0.3s;
    }

    .user-item:hover {
      border-color: var(--accent-color);
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .user-id {
      font-weight: 600;
      font-size: 14px;
      color: var(--accent-color);
      font-family: 'Courier New', monospace;
    }

    .user-nickname {
      font-size: 14px;
      color: var(--text-color);
      margin-left: 12px;
      opacity: 0.7;
    }

    .user-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .user-info-row {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 12px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .user-info-label {
      font-weight: 600;
      color: var(--text-color);
      opacity: 0.7;
    }

    .user-info-value {
      color: var(--accent-color);
      font-family: 'Courier New', monospace;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }

    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent-color);
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
      opacity: 0.5;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.3s;
    }

    .close-btn:hover {
      opacity: 1;
      background-color: var(--hover-bg);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 8px;
      opacity: 0.8;
    }

    .form-input, .form-textarea {
      width: 100%;
      padding: 12px 16px;
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-color);
      font-family: 'Courier New', monospace;
      transition: all 0.3s;
    }

    .form-textarea {
      min-height: 200px;
      resize: vertical;
    }

    .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    .btn-cancel {
      background-color: var(--border-color);
      color: var(--text-color);
    }

    /* Loading spinner */
    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border-color);
      border-top-color: var(--accent-color);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .nickname-loading {
      opacity: 0.5;
      font-style: italic;
    }

    .btn {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background-color: var(--info-color);
      color: white;
    }

    .btn-success {
      background-color: var(--success-color);
      color: white;
    }

    .btn-danger {
      background-color: var(--danger-color);
      color: white;
    }

    .btn-warning {
      background-color: var(--warning-color);
      color: black;
    }

    .btn:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .user-data {
      display: none;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border-color);
    }

    .user-data.expanded {
      display: block;
    }

    .json-viewer {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }

    .json-viewer pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: var(--text-color);
      line-height: 1.5;
    }

    .task-item {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .task-info {
      flex: 1;
    }

    .task-type {
      font-weight: 600;
      color: var(--accent-color);
      margin-bottom: 4px;
    }

    .task-user {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.7;
      font-family: 'Courier New', monospace;
    }

    .task-time {
      font-size: 11px;
      color: var(--text-color);
      opacity: 0.5;
      margin-top: 4px;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-right: 12px;
    }

    .status-running {
      background-color: rgba(40, 167, 69, 0.1);
      color: var(--success-color);
    }

    .status-queued {
      background-color: rgba(255, 193, 7, 0.1);
      color: var(--warning-color);
    }

    .status-cancelled {
      background-color: rgba(220, 53, 69, 0.1);
      color: var(--danger-color);
      text-decoration: line-through;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent-color);
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: var(--text-color);
      opacity: 0.6;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .search-box {
      width: 100%;
      padding: 12px 16px;
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      color: var(--text-color);
      margin-bottom: 16px;
      font-family: inherit;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--accent-color);
    }

    .log-viewer {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-color);
      opacity: 0.5;
    }

    .toggle-icon {
      font-size: 12px;
      margin-left: 8px;
      opacity: 0.5;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 16px;
      }

      .tabs {
        overflow-x: auto;
      }

      .user-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .user-actions {
        flex-direction: column;
        width: 100%;
        gap: 8px;
      }

      .user-actions .btn {
        width: 100%;
        padding: 10px 16px;
        font-size: 14px;
      }

      .task-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }

      .task-item > div:last-child {
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .task-item .btn {
        width: 100%;
        padding: 10px 16px;
        font-size: 14px;
      }

      .task-item .status-badge {
        width: 100%;
        text-align: center;
        padding: 8px 12px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .stat-card {
        padding: 20px;
      }

      .modal-content {
        margin: 20px;
        max-width: calc(100% - 40px);
      }

      .section-title {
        font-size: 16px;
      }

      .tabs {
        gap: 8px;
      }

      .tab {
        font-size: 13px;
        padding: 10px 16px;
      }

      body {
        padding: 10px;
      }
    }

    /* Animations */
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Admin Control Panel</h1>
      <a href="/linebot/admin/logout" class="logout-btn">Logout</a>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('stats')">Statistics</button>
      <button class="tab" onclick="switchTab('users')">Users</button>
      <button class="tab" onclick="switchTab('tasks')">Task Queue</button>
      <button class="tab" onclick="switchTab('notices')">Notices</button>
      <button class="tab" onclick="switchTab('logs')">Logs</button>
    </div>

    <!-- Users Tab -->
    <div id="users-tab" class="tab-content">
      <div class="section">
        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
          <span>User Management ({{ total_users }} users)</span>
          <button class="btn btn-warning" onclick="clearNicknameCache()" style="font-size: 12px;">
            Clear Nickname Cache
          </button>
        </div>

        <!-- Loading indicator -->
        <div id="nickname-loading" style="display: flex; align-items: center; justify-content: center; padding: 20px; gap: 12px;">
          <div class="spinner"></div>
          <span style="color: var(--text-color); opacity: 0.7;">Loading user nicknames...</span>
        </div>

        <input type="text" class="search-box" id="user-search" placeholder="Search by User ID or Nickname..." onkeyup="filterUsers()">

        <div class="user-list" id="user-list">
          {% if users_data %}
            {% for user_id, user_data in users_data.items() %}
            <div class="user-item" data-user-id="{{ user_id }}" data-nickname="{{ user_data.nickname|lower }}">
              <div class="user-header" onclick="toggleUserData('{{ user_id }}')">
                <div>
                  <span class="user-id">{{ user_id }}</span>
                  <span class="user-nickname">{{ user_data.nickname }}</span>
                </div>
                <div class="user-actions" onclick="event.stopPropagation()">
                  <button class="btn btn-primary" onclick="triggerUpdate('{{ user_id }}')">Update</button>
                  <button class="btn btn-success" onclick="refreshUserData('{{ user_id }}')">Refresh</button>
                  <button class="btn btn-warning" onclick="editUser('{{ user_id }}')">Edit</button>
                  <button class="btn btn-danger" onclick="deleteUser('{{ user_id }}')">Delete</button>
                  <span class="toggle-icon" id="toggle-{{ user_id }}">‚ñº</span>
                </div>
              </div>
              <div class="user-data" id="data-{{ user_id }}">
                <div class="json-viewer"><pre>{{ user_data.json_str }}</pre></div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty-state">No users found</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Tasks Tab -->
    <div id="tasks-tab" class="tab-content">
      <div class="section">
        <div class="section-title">Running Tasks ({{ running_tasks|length }})</div>
        {% if running_tasks %}
          {% for task in running_tasks %}
          <div class="task-item">
            <div class="task-info">
              <div class="task-type">{{ task.function }}</div>
              <div class="task-user">User: {{ task.user_id }} ({{ task.nickname }})</div>
              <div class="task-time">Started: {{ task.start_time }}</div>
            </div>
            <div>
              <span class="status-badge status-running">Running</span>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">No running tasks</div>
        {% endif %}
      </div>

      <div class="section">
        <div class="section-title">Queued Tasks ({{ queued_tasks|length }})</div>
        {% if queued_tasks %}
          {% for task in queued_tasks %}
          <div class="task-item">
            <div class="task-info">
              <div class="task-type">{{ task.function }}</div>
              <div class="task-user">User: {{ task.user_id }} ({{ task.nickname }})</div>
              <div class="task-time">Queued: {{ task.queue_time }}</div>
            </div>
            <div>
              {% if task.status == 'cancelled' %}
                <span class="status-badge status-cancelled">Cancelled</span>
              {% else %}
                <span class="status-badge status-queued">Queued</span>
                <button class="btn btn-danger" onclick="cancelTask('{{ task.id }}')">Cancel</button>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">No queued tasks</div>
        {% endif %}
      </div>

      <div class="section">
        <div class="section-title">Completed Tasks (Last 20)</div>
        {% if completed_tasks %}
          {% for task in completed_tasks %}
          <div class="task-item">
            <div class="task-info">
              <div class="task-type">{{ task.function }}</div>
              <div class="task-user">User: {{ task.user_id }} ({{ task.nickname }})</div>
              <div class="task-time">Started: {{ task.start_time }} | Finished: {{ task.end_time }}</div>
              <div class="task-time">Duration: {{ task.duration }}</div>
            </div>
            <div>
              <span class="status-badge" style="background-color: rgba(23, 162, 184, 0.1); color: var(--info-color);">Completed</span>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="empty-state">No completed tasks yet</div>
        {% endif %}
      </div>

      <div style="margin-top: 12px; text-align: center;">
        <button class="btn btn-primary" onclick="refreshTasks()">Refresh Tasks</button>
      </div>
    </div>

    <!-- Stats Tab -->
    <div id="stats-tab" class="tab-content active">
      <!-- Main Statistics Cards -->
      <div class="section">
        <div class="section-title">System Overview</div>
        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); margin-bottom: 20px;">
          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Total Users</div>
            <div class="stat-value" style="font-size: 32px;">{{ stats.total_users }}</div>
            <div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Registered accounts</div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">CPU Usage</div>
            <div class="stat-value" style="font-size: 32px;">{{ stats.cpu_percent }}<span style="font-size: 18px; opacity: 0.5; margin-left: 4px;">%</span></div>
            <div style="width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; margin-top: 8px; opacity: 0.3;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 3px; width: {{ stats.cpu_percent }}%;"></div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Memory</div>
            <div class="stat-value" style="font-size: 32px;">{{ stats.memory_percent }}<span style="font-size: 18px; opacity: 0.5; margin-left: 4px;">%</span></div>
            <div style="width: 100%; height: 6px; background: var(--border-color); border-radius: 3px; margin-top: 8px; opacity: 0.3;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 3px; width: {{ stats.memory_percent }}%;"></div>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Uptime</div>
            <div class="stat-value" style="font-size: 24px;">{{ stats.uptime }}</div>
            <div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Service running</div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Tasks Processed</div>
            <div class="stat-value" style="font-size: 28px;">{{ stats.total_tasks_processed }}</div>
            <div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Total completed</div>
          </div>

          <div class="stat-card">
            <div class="stat-label" style="font-size: 11px; opacity: 0.6; margin-bottom: 8px;">Active Threads</div>
            <div class="stat-value" style="font-size: 32px;">{{ stats.thread_count }}</div>
            <div style="font-size: 12px; opacity: 0.5; margin-top: 4px;">Worker threads</div>
          </div>
        </div>
      </div>

      <!-- System Resources -->
      <div class="section">
        <div class="section-title">System Resources</div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 120px; font-size: 13px; opacity: 0.7;">CPU Cores</div>
            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; opacity: 0.3; overflow: hidden;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 4px; width: {{ (stats.cpu_count_used / stats.cpu_count_total * 100) if stats.cpu_count_total > 0 else 0 }}%;"></div>
            </div>
            <div style="min-width: 80px; text-align: right; font-size: 13px; font-weight: 600;">{{ stats.cpu_count_used }} / {{ stats.cpu_count_total }}</div>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 120px; font-size: 13px; opacity: 0.7;">Memory</div>
            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; opacity: 0.3; overflow: hidden;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 4px; width: {{ stats.memory_percent }}%;"></div>
            </div>
            <div style="min-width: 80px; text-align: right; font-size: 13px; font-weight: 600;">{{ stats.memory_used_gb }} / {{ stats.total_memory }} GB</div>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 120px; font-size: 13px; opacity: 0.7;">Image Queue</div>
            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; opacity: 0.3; overflow: hidden;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 4px; width: {{ (stats.image_queue_size / stats.max_queue_size * 100) if stats.max_queue_size > 0 else 0 }}%;"></div>
            </div>
            <div style="min-width: 80px; text-align: right; font-size: 13px; font-weight: 600;">{{ stats.image_queue_size }} / {{ stats.max_queue_size }}</div>
          </div>
        </div>

        <div style="margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <div style="min-width: 120px; font-size: 13px; opacity: 0.7;">Web Queue</div>
            <div style="flex: 1; height: 8px; background: var(--border-color); border-radius: 4px; opacity: 0.3; overflow: hidden;">
              <div style="height: 100%; background: var(--accent-color); border-radius: 4px; width: {{ (stats.web_queue_size / stats.max_queue_size * 100) if stats.max_queue_size > 0 else 0 }}%;"></div>
            </div>
            <div style="min-width: 80px; text-align: right; font-size: 13px; font-weight: 600;">{{ stats.web_queue_size }} / {{ stats.max_queue_size }}</div>
          </div>
        </div>

        <!-- User Distribution -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">
          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">JP Users</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">{{ stats.jp_users }}</div>
            <div style="font-size: 13px; opacity: 0.5;">{{ stats.jp_percent }}% of total</div>
          </div>
          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">INTL Users</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">{{ stats.intl_users }}</div>
            <div style="font-size: 13px; opacity: 0.5;">{{ stats.intl_percent }}% of total</div>
          </div>
        </div>
      </div>

      <!-- Memory Management -->
      <div class="section">
        <div class="section-title" style="display: flex; justify-content: space-between; align-items: center;">
          <span>Memory Management</span>
          <button class="btn btn-warning" onclick="triggerMemoryCleanup()" style="font-size: 12px;">
            Trigger Cleanup
          </button>
        </div>

        <div id="memory-stats-container">
          <div style="text-align: center; padding: 40px; opacity: 0.5;">
            Loading memory stats...
          </div>
        </div>

        <div style="margin-top: 12px; text-align: center;">
          <button class="btn btn-primary" onclick="loadMemoryStats()">Refresh Stats</button>
        </div>
      </div>

      <!-- System Information -->
      <div class="section">
        <div class="section-title">System Information</div>

        <div style="margin-bottom: 20px;">
          <span style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 20px; font-size: 13px; font-weight: 600;">
            <span style="width: 8px; height: 8px; border-radius: 50%; background: var(--success-color); animation: pulse 2s infinite;"></span>
            Service Online
          </span>
        </div>

        <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Python</span>
            <span style="font-weight: 600;">{{ stats.python_version }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Platform</span>
            <span style="font-weight: 600;">{{ stats.platform_short }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Hostname</span>
            <span style="font-weight: 600;">{{ stats.hostname }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Port</span>
            <span style="font-weight: 600;">{{ stats.port }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Total Tasks</span>
            <span style="font-weight: 600;">{{ stats.total_tasks_processed }}</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px;">
            <span style="opacity: 0.7;">Avg Response</span>
            <span style="font-weight: 600;">{{ stats.avg_response_time }}ms</span>
          </div>
        </div>

        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); opacity: 0.5; font-size: 13px;">
          <p>Last updated: {{ stats.timestamp }}</p>
        </div>
      </div>
    </div>

    <!-- Notices Tab -->
    <div id="notices-tab" class="tab-content">
      <div class="section">
        <div class="section-title">
          Notice Management
          <button class="btn btn-success" onclick="showCreateNoticeModal()" style="float: right;">Create New Notice</button>
        </div>

        <div id="notices-list">
          <div style="text-align: center; padding: 40px; color: var(--text-color); opacity: 0.5;">
            Loading notices...
          </div>
        </div>

        <div style="margin-top: 12px; text-align: center;">
          <button class="btn btn-primary" onclick="loadNotices()">Refresh</button>
        </div>
      </div>
    </div>

    <!-- Logs Tab -->
    <div id="logs-tab" class="tab-content">
      <div class="section">
        <div class="section-title">Recent Logs (Last 100 lines)</div>
        <div class="log-viewer" id="log-viewer">{{ logs }}</div>
        <div style="margin-top: 12px; text-align: center;">
          <button class="btn btn-primary" onclick="refreshLogs()">Refresh Logs</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Edit User Data</h2>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>

      <form id="editUserForm" onsubmit="saveUserData(event)">
        <div class="form-group">
          <label class="form-label">User ID (Read-only)</label>
          <input type="text" id="edit-user-id" class="form-input" readonly>
        </div>

        <div class="form-group">
          <label class="form-label">User Data (JSON)</label>
          <textarea id="edit-user-data" class="form-textarea" placeholder='{"key": "value"}'></textarea>
          <small style="opacity: 0.6; font-size: 12px;">
            ‚ö†Ô∏è Be careful when editing JSON. Invalid JSON will be rejected.
          </small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-success">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Notice Modal -->
  <div id="noticeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="notice-modal-title">Create Notice</h2>
        <button class="close-btn" onclick="closeNoticeModal()">&times;</button>
      </div>

      <form id="noticeForm" onsubmit="saveNotice(event)">
        <input type="hidden" id="notice-id">

        <div class="form-group">
          <label class="form-label">Notice Content</label>
          <textarea id="notice-content" class="form-textarea" rows="6" placeholder="Enter notice content..." required></textarea>
          <small style="opacity: 0.6; font-size: 12px;">
            üí° This will be shown to users when they interact with the bot.
          </small>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-cancel" onclick="closeNoticeModal()">Cancel</button>
          <button type="submit" class="btn btn-success" id="notice-save-btn">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');

      // Save to localStorage
      localStorage.setItem('admin_active_tab', tabName);

      // Â¶ÇÊûúÂàáÊç¢Âà∞logsÊ†áÁ≠æÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
      if (tabName === 'logs') {
        setTimeout(scrollLogsToBottom, 100);
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞noticesÊ†áÁ≠æÔºåÂä†ËΩΩÂÖ¨Âëä
      if (tabName === 'notices') {
        loadNotices();
      }

      // Â¶ÇÊûúÂàáÊç¢Âà∞statsÊ†áÁ≠æÔºåÂä†ËΩΩÂÜÖÂ≠òÁªüËÆ°
      if (tabName === 'stats') {
        loadMemoryStats();
      }
    }

    // Restore tab on page load
    window.addEventListener('DOMContentLoaded', function() {
      const savedTab = localStorage.getItem('admin_active_tab');
      if (savedTab && document.getElementById(savedTab + '-tab')) {
        // Hide all tabs first
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Show saved tab
        document.getElementById(savedTab + '-tab').classList.add('active');
        document.querySelector('.tab[onclick*="' + savedTab + '"]').classList.add('active');

        // Â¶ÇÊûúÊÅ¢Â§çÁöÑÊòØlogsÊ†áÁ≠æÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
        if (savedTab === 'logs') {
          setTimeout(scrollLogsToBottom, 100);
        }
      }

      // ËΩ¨Êç¢Êó•Âøó‰∏≠ÁöÑ ANSI È¢úËâ≤‰ª£Á†Å
      const logViewer = document.getElementById('log-viewer');
      if (logViewer && logViewer.textContent) {
        const logText = logViewer.textContent;
        logViewer.innerHTML = ansiToHtml(logText);
      }

      // Â¶ÇÊûúÂΩìÂâçÊòæÁ§∫ÁöÑÊòØlogsÊ†áÁ≠æÔºàÈªòËÆ§ÊàñÊÅ¢Â§çÁöÑÔºâÔºåÊªöÂä®Âà∞Â∫ïÈÉ®
      if (document.getElementById('logs-tab').classList.contains('active')) {
        setTimeout(scrollLogsToBottom, 100);
      }
    });

    function toggleUserData(userId) {
      const dataElement = document.getElementById('data-' + userId);
      const toggleIcon = document.getElementById('toggle-' + userId);

      if (dataElement.classList.contains('expanded')) {
        dataElement.classList.remove('expanded');
        toggleIcon.textContent = '‚ñº';
      } else {
        dataElement.classList.add('expanded');
        toggleIcon.textContent = '‚ñ≤';
      }
    }

    function triggerUpdate(userId) {
      if (confirm('Trigger maimai_update for user ' + userId + '?\n\nThe update will run in the background.')) {
        // Á¶ÅÁî®ÊåâÈíÆ,ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        const btn = event.target;
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'Queuing...';

        fetch('/linebot/admin/trigger_update', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: userId})
        })
        .then(res => res.json())
        .then(data => {
          // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ‰ΩÜ‰∏çÈáçËΩΩÈ°µÈù¢
          alert('‚úÖ ' + (data.message || 'Update task queued successfully!\n\nThe update is running in the background.\nYou will receive a notification when it completes.'));

          // ÊÅ¢Â§çÊåâÈíÆ
          btn.disabled = false;
          btn.textContent = originalText;
        })
        .catch(err => {
          alert('‚ùå Error: ' + err);
          btn.disabled = false;
          btn.textContent = originalText;
        });
      }
    }

    function refreshUserData(userId) {
      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Loading...';

      fetch('/linebot/admin/get_user_data', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_id: userId})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // Êõ¥Êñ∞ JSON ÊòæÁ§∫
          const jsonViewer = document.querySelector('#data-' + userId + ' .json-viewer pre');
          jsonViewer.textContent = data.json_str;

          // Êõ¥Êñ∞ÊòµÁß∞
          const nicknameElement = document.querySelector('[data-user-id="' + userId + '"] .user-nickname');
          nicknameElement.textContent = data.nickname;

          // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
          showToast('‚úÖ User data refreshed', 'success');
        } else {
          alert('‚ùå Error: ' + (data.message || 'Unknown error'));
        }

        btn.disabled = false;
        btn.textContent = originalText;
      })
      .catch(err => {
        alert('‚ùå Network error: ' + err);
        btn.disabled = false;
        btn.textContent = originalText;
      });
    }

    // ÁÆÄÂçïÁöÑ Toast ÈÄöÁü•
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 600;
        animation: slideIn 0.3s ease;
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(400px); opacity: 0; }
      }
    `;
    document.head.appendChild(style);

    function editUser(userId) {
      // ‰ªéÈ°µÈù¢‰∏≠Ëé∑ÂèñÁî®Êà∑Êï∞ÊçÆ
      const userDataElement = document.getElementById('data-' + userId);
      const jsonStr = userDataElement.querySelector('pre').textContent;

      document.getElementById('edit-user-id').value = userId;
      document.getElementById('edit-user-data').value = jsonStr;
      document.getElementById('editUserModal').classList.add('show');
    }

    function closeEditModal() {
      document.getElementById('editUserModal').classList.remove('show');
    }

    function saveUserData(event) {
      event.preventDefault();

      const userId = document.getElementById('edit-user-id').value;
      const userDataStr = document.getElementById('edit-user-data').value;

      // Validate JSON
      try {
        const userData = JSON.parse(userDataStr);

        if (!confirm('Save changes for user ' + userId + '?')) {
          return;
        }

        fetch('/linebot/admin/edit_user', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: userId,
            user_data: userData
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ User data saved successfully!');
            closeEditModal();
            location.reload();
          } else {
            alert('‚ùå Error: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(err => {
          alert('‚ùå Network error: ' + err);
        });
      } catch (e) {
        alert('‚ùå Invalid JSON format!\n\n' + e.message);
      }
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('editUserModal');
      if (event.target === modal) {
        closeEditModal();
      }
    }

    function deleteUser(userId) {
      if (confirm('‚ö†Ô∏è Are you sure you want to delete this user?\n\nUser ID: ' + userId + '\n\nThis action CANNOT be undone!')) {
        const button = event.target;
        button.disabled = true;
        button.textContent = 'Deleting...';

        fetch('/linebot/admin/delete_user', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user_id: userId})
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('‚úì User deleted successfully');
            // ÁßªÈô§Áî®Êà∑ÂÖÉÁ¥†
            const userElement = document.querySelector('[data-user-id="' + userId + '"]');
            if (userElement) {
              userElement.style.opacity = '0';
              userElement.style.transition = 'opacity 0.3s';
              setTimeout(() => userElement.remove(), 300);
            }
          } else {
            showToast('‚úó ' + (data.message || 'Failed to delete user'));
            button.disabled = false;
            button.textContent = 'Delete';
          }
        })
        .catch(err => {
          showToast('‚úó Error: ' + err);
          button.disabled = false;
          button.textContent = 'Delete';
        });
      }
    }

    function cancelTask(taskId) {
      if (confirm('Cancel this task?')) {
        const button = event.target;
        button.disabled = true;
        button.textContent = 'Cancelling...';

        fetch('/linebot/admin/cancel_task', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({task_id: taskId})
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            showToast('‚úì Task cancelled successfully');
            // Âà∑Êñ∞È°µÈù¢‰ª•Êõ¥Êñ∞‰ªªÂä°ÂàóË°®
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast('‚úó ' + (data.message || 'Failed to cancel task'));
            button.disabled = false;
            button.textContent = 'Cancel';
          }
        })
        .catch(err => {
          showToast('‚úó Error: ' + err);
          button.disabled = false;
          button.textContent = 'Cancel';
        });
      }
    }

    function filterUsers() {
      const searchTerm = document.getElementById('user-search').value.toLowerCase();
      const userItems = document.querySelectorAll('.user-item');

      userItems.forEach(item => {
        const userId = item.dataset.userId.toLowerCase();
        const nickname = item.dataset.nickname;

        if (userId.includes(searchTerm) || nickname.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function scrollLogsToBottom() {
      const logViewer = document.getElementById('log-viewer');
      if (logViewer) {
        logViewer.scrollTop = logViewer.scrollHeight;
      }
    }

    function ansiToHtml(text) {
      // ANSI È¢úËâ≤‰ª£Á†ÅÊò†Â∞Ñ
      const colors = {
        '30': '#000000', '31': '#cd3131', '32': '#0dbc79', '33': '#e5e510',
        '34': '#2472c8', '35': '#bc3fbc', '36': '#11a8cd', '37': '#e5e5e5',
        '90': '#666666', '91': '#f14c4c', '92': '#23d18b', '93': '#f5f543',
        '94': '#3b8eea', '95': '#d670d6', '96': '#29b8db', '97': '#ffffff',
        '40': '#000000', '41': '#cd3131', '42': '#0dbc79', '43': '#e5e510',
        '44': '#2472c8', '45': '#bc3fbc', '46': '#11a8cd', '47': '#e5e5e5'
      };

      let html = '';
      let currentStyle = '';

      // ËΩ¨‰πâ HTML ÁâπÊÆäÂ≠óÁ¨¶
      text = text.replace(/&/g, '&amp;')
                 .replace(/</g, '&lt;')
                 .replace(/>/g, '&gt;');

      // Ëß£Êûê ANSI ‰ª£Á†Å
      const parts = text.split(/\x1b\[([0-9;]+)m/);

      for (let i = 0; i < parts.length; i++) {
        if (i % 2 === 0) {
          // ÊñáÊú¨ÈÉ®ÂàÜ
          if (currentStyle) {
            html += '<span style="' + currentStyle + '">' + parts[i] + '</span>';
          } else {
            html += parts[i];
          }
        } else {
          // ANSI ‰ª£Á†ÅÈÉ®ÂàÜ
          const codes = parts[i].split(';');
          let styles = [];

          for (const code of codes) {
            if (code === '0' || code === '') {
              // ÈáçÁΩÆ
              currentStyle = '';
            } else if (code === '1') {
              // Á≤ó‰Ωì
              styles.push('font-weight: bold');
            } else if (code === '4') {
              // ‰∏ãÂàíÁ∫ø
              styles.push('text-decoration: underline');
            } else if (colors[code]) {
              // ÂâçÊôØËâ≤
              if (code.startsWith('3') || code.startsWith('9')) {
                styles.push('color: ' + colors[code]);
              }
              // ËÉåÊôØËâ≤
              else if (code.startsWith('4')) {
                styles.push('background-color: ' + colors[code]);
              }
            }
          }

          currentStyle = styles.join('; ');
        }
      }

      return html;
    }

    function refreshLogs() {
      fetch('/linebot/admin/get_logs')
        .then(res => res.json())
        .then(data => {
          const logViewer = document.getElementById('log-viewer');
          // ‰ΩøÁî® innerHTML ËÄå‰∏çÊòØ textContent Êù•ÊîØÊåÅ HTML
          logViewer.innerHTML = ansiToHtml(data.logs);
          // ÊªöÂä®Âà∞Â∫ïÈÉ®
          scrollLogsToBottom();
        })
        .catch(err => alert('Error refreshing logs: ' + err));
    }

    function refreshTasks() {
      // ÈáçÊñ∞Âä†ËΩΩÈ°µÈù¢‰ª•Âà∑Êñ∞‰ªªÂä°ÂàóË°®
      location.reload();
    }

    function clearNicknameCache() {
      if (confirm('Clear nickname cache? This will force a refresh from LINE API on next load.')) {
        fetch('/linebot/admin/clear_cache', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('‚úÖ Nickname cache cleared! Refresh the page to reload nicknames.');
          } else {
            alert('‚ùå Error: ' + (data.message || 'Unknown error'));
          }
        })
        .catch(err => alert('‚ùå Network error: ' + err));
      }
    }

    // Auto-refresh task queue every 10 seconds
    setInterval(() => {
      if (document.getElementById('tasks-tab').classList.contains('active')) {
        location.reload();
      }
    }, 10000);

    // Lazy load nicknames after page loads
    window.addEventListener('DOMContentLoaded', function() {
      loadAllNicknames();
    });

    function updateTaskNicknames(userId, nickname) {
      // Êõ¥Êñ∞‰ªªÂä°ÈòüÂàó‰∏≠ÊâÄÊúâÂåÖÂê´ËØ•Áî®Êà∑IDÁöÑÊòµÁß∞
      const taskUserElements = document.querySelectorAll('.task-user');
      taskUserElements.forEach(element => {
        const text = element.textContent;
        // ÂåπÈÖç "User: {userId} (Loading...)" Êàñ "User: {userId} ({‰ªª‰ΩïÊòµÁß∞})"
        const regex = new RegExp('User: ' + userId.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ' \\(.*?\\)');
        if (regex.test(text)) {
          element.textContent = 'User: ' + userId + ' (' + nickname + ')';
        }
      });
    }

    function loadAllNicknames() {
      fetch('/linebot/admin/load_nicknames', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®
          const loadingIndicator = document.getElementById('nickname-loading');
          if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
          }

          // Êõ¥Êñ∞ÊâÄÊúâÁî®Êà∑ÁöÑÊòµÁß∞
          const nicknames = data.nicknames;
          for (const userId in nicknames) {
            const nicknameElement = document.querySelector('[data-user-id="' + userId + '"] .user-nickname');
            if (nicknameElement) {
              nicknameElement.textContent = nicknames[userId];
            }

            // Êõ¥Êñ∞ÊêúÁ¥¢Áî®ÁöÑ data Â±ûÊÄß
            const userItem = document.querySelector('[data-user-id="' + userId + '"]');
            if (userItem) {
              userItem.setAttribute('data-nickname', nicknames[userId].toLowerCase());
            }

            // Êõ¥Êñ∞‰ªªÂä°ÈòüÂàó‰∏≠ÁöÑÊòµÁß∞
            updateTaskNicknames(userId, nicknames[userId]);
          }

          console.log('Loaded ' + data.count + ' nicknames');
        } else {
          console.error('Failed to load nicknames:', data.message);
          // ÈöêËóèÂä†ËΩΩÊåáÁ§∫Âô®Âç≥‰ΩøÂ§±Ë¥•
          const loadingIndicator = document.getElementById('nickname-loading');
          if (loadingIndicator) {
            loadingIndicator.innerHTML = '<span style="color: var(--danger-color);">‚ö†Ô∏è Failed to load nicknames</span>';
          }
        }
      })
      .catch(err => {
        console.error('Error loading nicknames:', err);
        const loadingIndicator = document.getElementById('nickname-loading');
        if (loadingIndicator) {
          loadingIndicator.innerHTML = '<span style="color: var(--danger-color);">‚ö†Ô∏è Network error</span>';
        }
      });
    }

    // ==================== Notice Management Functions ====================

    function loadNotices() {
      fetch('/linebot/admin/get_notices')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayNotices(data.notices);
          } else {
            showToast('‚úó Failed to load notices: ' + data.message);
          }
        })
        .catch(err => {
          showToast('‚úó Network error: ' + err);
        });
    }

    function displayNotices(notices) {
      const container = document.getElementById('notices-list');

      if (!notices || notices.length === 0) {
        container.innerHTML = '<div class="empty-state">No notices found</div>';
        return;
      }

      container.innerHTML = ''; // Ê∏ÖÁ©∫ÂÆπÂô®

      for (const notice of notices) {
        const noticeItem = document.createElement('div');
        noticeItem.className = 'task-item';
        noticeItem.style.marginBottom = '16px';

        const taskInfo = document.createElement('div');
        taskInfo.className = 'task-info';
        taskInfo.style.flex = '1';

        const contentDiv = document.createElement('div');
        contentDiv.style.fontWeight = '600';
        contentDiv.style.marginBottom = '8px';
        contentDiv.textContent = notice.content;

        const metaDiv = document.createElement('div');
        metaDiv.style.fontSize = '11px';
        metaDiv.style.opacity = '0.5';
        metaDiv.textContent = `ID: ${notice.id} | Created: ${notice.date}`;

        taskInfo.appendChild(contentDiv);
        taskInfo.appendChild(metaDiv);

        const actionsDiv = document.createElement('div');
        actionsDiv.style.display = 'flex';
        actionsDiv.style.gap = '8px';
        actionsDiv.style.alignItems = 'center';

        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-warning';
        editBtn.textContent = 'Edit';
        editBtn.onclick = () => editNotice(notice.id);

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn btn-danger';
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteNoticeConfirm(notice.id);

        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(deleteBtn);

        noticeItem.appendChild(taskInfo);
        noticeItem.appendChild(actionsDiv);

        container.appendChild(noticeItem);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showCreateNoticeModal() {
      document.getElementById('notice-modal-title').textContent = 'Create New Notice';
      document.getElementById('notice-id').value = '';
      document.getElementById('notice-content').value = '';
      document.getElementById('notice-save-btn').textContent = 'Create';
      document.getElementById('noticeModal').style.display = 'block';
    }

    function editNotice(noticeId) {
      fetch('/linebot/admin/get_notices')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const notice = data.notices.find(n => n.id === noticeId);
            if (notice) {
              document.getElementById('notice-modal-title').textContent = 'Edit Notice';
              document.getElementById('notice-id').value = notice.id;
              document.getElementById('notice-content').value = notice.content;
              document.getElementById('notice-save-btn').textContent = 'Update';
              document.getElementById('noticeModal').style.display = 'block';
            }
          }
        });
    }

    function saveNotice(event) {
      event.preventDefault();

      const noticeId = document.getElementById('notice-id').value;
      const content = document.getElementById('notice-content').value.trim();

      if (!content) {
        showToast('‚úó Content cannot be empty');
        return;
      }

      const isUpdate = !!noticeId;
      const url = isUpdate ? '/linebot/admin/update_notice' : '/linebot/admin/create_notice';
      const payload = isUpdate
        ? { notice_id: noticeId, content: content }
        : { content: content };

      const btn = document.getElementById('notice-save-btn');
      btn.disabled = true;
      btn.textContent = isUpdate ? 'Updating...' : 'Creating...';

      fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast(`‚úì Notice ${isUpdate ? 'updated' : 'created'} successfully`);
          closeNoticeModal();
          loadNotices();
        } else {
          showToast('‚úó ' + data.message);
        }
        btn.disabled = false;
        btn.textContent = isUpdate ? 'Update' : 'Create';
      })
      .catch(err => {
        showToast('‚úó Network error: ' + err);
        btn.disabled = false;
        btn.textContent = isUpdate ? 'Update' : 'Create';
      });
    }

    function deleteNoticeConfirm(noticeId) {
      if (!confirm('Are you sure you want to delete this notice?\n\nThis action cannot be undone.')) {
        return;
      }

      fetch('/linebot/admin/delete_notice', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({notice_id: noticeId})
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('‚úì Notice deleted successfully');
          loadNotices();
        } else {
          showToast('‚úó ' + data.message);
        }
      })
      .catch(err => {
        showToast('‚úó Network error: ' + err);
      });
    }

    function closeNoticeModal() {
      document.getElementById('noticeModal').style.display = 'none';
      document.getElementById('noticeForm').reset();
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
      const noticeModal = document.getElementById('noticeModal');
      if (event.target === noticeModal) {
        closeNoticeModal();
      }
    }

    // Load notices when notices tab is opened
    document.addEventListener('DOMContentLoaded', function() {
      if (document.getElementById('notices-tab').classList.contains('active')) {
        loadNotices();
      }

      // Load memory stats if on stats tab
      if (document.getElementById('stats-tab').classList.contains('active')) {
        loadMemoryStats();
      }
    });

    // ==================== Memory Management Functions ====================

    function loadMemoryStats() {
      const container = document.getElementById('memory-stats-container');
      container.innerHTML = '<div style="text-align: center; padding: 40px; opacity: 0.5;">Loading...</div>';

      fetch('/linebot/admin/memory_stats')
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayMemoryStats(data.stats);
          } else {
            container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger-color);">Failed to load memory stats</div>';
          }
        })
        .catch(err => {
          container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--danger-color);">Network error: ' + err + '</div>';
        });
    }

    function displayMemoryStats(stats) {
      const container = document.getElementById('memory-stats-container');

      const html = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Status</div>
            <div style="font-size: 24px; font-weight: 700; color: ${stats.running ? 'var(--success-color)' : 'var(--danger-color)'}; margin-bottom: 4px;">
              ${stats.running ? 'Running' : 'Stopped'}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Memory Manager</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Interval</div>
            <div style="font-size: 32px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${stats.interval_seconds}<span style="font-size: 18px; opacity: 0.5; margin-left: 4px;">s</span>
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Cleanup interval</div>
          </div>

          <div style="padding: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
            <div style="font-size: 12px; opacity: 0.6; margin-bottom: 8px;">Last Cleanup</div>
            <div style="font-size: 16px; font-weight: 700; color: var(--accent-color); margin-bottom: 4px;">
              ${stats.last_cleanup}
            </div>
            <div style="font-size: 13px; opacity: 0.5;">Last run time</div>
          </div>
        </div>

        <div style="padding: 16px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 12px;">
          <div style="font-size: 12px; font-weight: 600; opacity: 0.7; margin-bottom: 12px;">Garbage Collector Statistics</div>

          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
            <div>
              <div style="font-size: 11px; opacity: 0.5; margin-bottom: 4px;">Gen 0 Count</div>
              <div style="font-size: 20px; font-weight: 600;">${stats.gc_counts[0]}</div>
            </div>
            <div>
              <div style="font-size: 11px; opacity: 0.5; margin-bottom: 4px;">Gen 1 Count</div>
              <div style="font-size: 20px; font-weight: 600;">${stats.gc_counts[1]}</div>
            </div>
            <div>
              <div style="font-size: 11px; opacity: 0.5; margin-bottom: 4px;">Gen 2 Count</div>
              <div style="font-size: 20px; font-weight: 600;">${stats.gc_counts[2]}</div>
            </div>
          </div>

          <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
            <div style="font-size: 11px; opacity: 0.5; margin-bottom: 8px;">GC Thresholds</div>
            <div style="font-size: 13px; font-family: 'Courier New', monospace;">
              Gen 0: ${stats.gc_threshold[0]} | Gen 1: ${stats.gc_threshold[1]} | Gen 2: ${stats.gc_threshold[2]}
            </div>
          </div>
        </div>
      `;

      container.innerHTML = html;
    }

    function triggerMemoryCleanup() {
      if (!confirm('Trigger manual memory cleanup?\n\nThis will run garbage collection and clear expired caches.')) {
        return;
      }

      const btn = event.target;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Cleaning...';

      fetch('/linebot/admin/trigger_cleanup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast('‚úì Memory cleanup completed: ' + data.stats.collected_objects + ' objects collected in ' + data.stats.elapsed_ms + 'ms');
          // Reload stats
          setTimeout(() => loadMemoryStats(), 500);
        } else {
          showToast('‚úó Cleanup failed: ' + data.message);
        }
        btn.disabled = false;
        btn.textContent = originalText;
      })
      .catch(err => {
        showToast('‚úó Network error: ' + err);
        btn.disabled = false;
        btn.textContent = originalText;
      });
    }
  </script>
</body>
</html>
